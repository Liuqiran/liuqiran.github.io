{{/* layouts/partials/comments.html */}}

{{/* ===== 1) æå‰å®šä¹‰ï¼šlang / waline server / hasWaline / commentPathï¼ˆåªå®šä¹‰ä¸€æ¬¡ï¼‰===== */}}
{{- $lang := .Lang -}}

{{- $server := "" -}}
{{- with site.Params.waline.serverURL -}}
  {{- $server = . -}}
{{- end -}}
{{- $hasWaline := ne $server "" -}}

{{/* Waline / Giscus çš„è¯­è¨€æ˜ å°„ */}}
{{- $walineLang := "en" -}}
{{- $giscusLang := "en" -}}
{{- if eq $lang "zh" -}}
  {{- $walineLang = "zh-CN" -}}
  {{- $giscusLang = "zh-CN" -}}
{{- else if eq $lang "ja" -}}
  {{- $walineLang = "ja" -}}
  {{- $giscusLang = "ja" -}}
{{- end -}}

{{/* commentPathï¼ˆçº¿ç¨‹IDï¼‰ä¼˜å…ˆçº§ï¼šç”¨ if/else-if é“¾ï¼Œé¿å… with/else-if è§£ææŠ¥é”™ */}}
{{- $commentPath := "" -}}
{{- if .Params.waline_path -}}
  {{- $commentPath = .Params.waline_path -}}
{{- else if .Params.url -}}
  {{- $commentPath = .Params.url -}}
{{- else if .Params.aliases -}}
  {{- $commentPath = index .Params.aliases 0 -}}
{{- else if .Params.translationKey -}}
  {{- $commentPath = printf "t:%s" .Params.translationKey -}}
{{- else -}}
  {{- $commentPath = .RelPermalink | replaceRE "^/(en|zh|ja)/" "/" -}}
{{- end -}}
{{- $commentPath = $commentPath | replaceRE "/$" "" -}}

<style>
/* ===== Toggle UI ===== */
.comment-toggle { margin: 1em 0; text-align: center; }
.comment-toggle button{
  padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
  border:1px solid var(--border, #ccc);
  background: var(--entry, #f8f8f8);
  color: var(--content, #555);
  font-weight:500; border-radius:8px; font-size:.9rem;
  transition: background .2s, color .2s, border-color .2s;
}
.comment-toggle button:hover{
  background: var(--code-bg, #eaeaea);
  border-color: var(--border, #999);
}
.comment-toggle button.active{
  background: var(--code-bg, #ddd);
  border-color: var(--border, #999);
  color: var(--content, #222);
  cursor:default; pointer-events:none;
}
.comment-system{ display:none; }
.comment-system.active{ display:block; }

/* ===== Invite copy ===== */
.comment-invite{ text-align:center; margin:1.2em 0 .6em; }
.comment-invite__title{ font-size:1rem; font-weight:500; }
.comment-invite__sub{ margin-top:.25em; font-size:.9rem; opacity:.75; }

/* ===== è¯„è®ºåŒºå­—ä½“ï¼šç”¨ lang å‰ç¼€åŒ¹é…æ›´ç¨³ ===== */
html[lang^="en"] .comment-system,
html[lang^="en"] .comment-system *{
  font-family:"Georgia","Times New Roman",serif !important;
  font-size:1rem !important; font-weight:400 !important; line-height:1.55 !important;
}
html[lang^="zh"] .comment-system,
html[lang^="zh"] .comment-system *{
  font-family:'KingHwa_OldSong',sans-serif !important;
  font-size:0.95rem !important; font-weight:400 !important; line-height:1.75 !important;
}
html[lang^="ja"] .comment-system,
html[lang^="ja"] .comment-system *{
  font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", system-ui, sans-serif !important;
  font-size:0.95rem !important; font-weight:400 !important; line-height:1.78 !important;
}

/* ===== Walineï¼šç”¨ PaperMod å˜é‡æ¥ç®¡ä¸»é¢˜è‰²ï¼ˆå»æ‰é»˜è®¤è“ï¼‰===== */
#waline{
  --waline-theme-color: var(--primary);
  --waline-active-color: var(--primary);
  --waline-color: var(--content);
  --waline-bg-color: var(--entry);
  --waline-bg-color-light: var(--code-bg);
  --waline-border-color: var(--border);
  --waline-box-shadow: none;
}
/* PaperMod æš—è‰²ä¸€èˆ¬æ˜¯ body.dark */
body.dark #waline{
  /* å¯é€‰ï¼šæƒ³æ›´é»‘å°±è§£é™¤æ³¨é‡Š
  --waline-bg-color: #16181a;
  --waline-bg-color-light: #1f2225;
  --waline-border-color: #2a2e33;
  */
}
</style>

{{/* ===== 2) Invite æ–‡æ¡ˆ ===== */}}
{{- $invites := dict
  "zh" (slice
    (dict "t" "ä½ çš„ç•™è¨€ï¼Œæ˜¯æˆ‘ç»§ç»­å†™ä¸‹å»çš„åŠ¨åŠ› ğŸ‘‡" "s" "çŸ­å¥ä¹Ÿå¾ˆçè´µï¼Œæˆ‘ä¼šè®¤çœŸè¯»ã€‚")
    (dict "t" "å¦‚æœè¿™ç¯‡å¯¹ä½ æœ‰ä¸€ç‚¹å¸®åŠ©ï¼Œæ¬¢è¿ç•™ä¸€å¥è¯è®©æˆ‘çŸ¥é“ ğŸ‘‡" "s" "å“ªæ€•ä¸€ä¸ªè¡¨æƒ…ä¹Ÿå¯ä»¥ã€‚")
    (dict "t" "ä¸€å¥è¯å°±å¥½ï¼šä½ çœ‹å®Œæœ€å¤§çš„æ”¶è·æ˜¯ä»€ä¹ˆï¼ŸğŸ‘‡" "s" "æˆ‘æƒ³çŸ¥é“ä½ å¸¦èµ°äº†ä»€ä¹ˆã€‚")
    (dict "t" "çœ‹åˆ°ä½ å‚ä¸ï¼Œæˆ‘å°±çŸ¥é“è¿™ç¯‡æ²¡æœ‰ç™½å†™ ğŸ‘‡" "s" "è°¢è°¢ä½ æŠŠæ—¶é—´ç•™åœ¨è¿™é‡Œã€‚")
  )
  "en" (slice
    (dict "t" "Thanks for being hereâ€”this wasnâ€™t written into the void. ğŸ‘‡" "s" "I read every note.")
    (dict "t" "Your comment keeps me writing. ğŸ‘‡" "s" "Even a short note means a lot.")
    (dict "t" "One line is enough: whatâ€™s your biggest takeaway? ğŸ‘‡" "s" "Iâ€™d love to hear what you took from this.")
  )
  "ja" (slice
    (dict "t" "ã‚³ãƒ¡ãƒ³ãƒˆãŒã€æ›¸ãç¶šã‘ã‚‹åŠ›ã«ãªã‚Šã¾ã™ ğŸ‘‡" "s" "çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚å…¨éƒ¨èª­ã¿ã¾ã™ã€‚")
    (dict "t" "å°‘ã—ã§ã‚‚å½¹ã«ç«‹ã£ãŸã‚‰ã€ä¸€è¨€ã ã‘ã§ã‚‚æ®‹ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™ ğŸ‘‡" "s" "çµµæ–‡å­—ã ã‘ã§ã‚‚OKã§ã™ã€‚")
  )
-}}

{{- $list := index $invites $lang -}}
{{- if not $list -}}{{- $list = index $invites "en" -}}{{- end -}}

{{- $seedBase := .RelPermalink -}}
{{- with .File -}}{{- $seedBase = .Path -}}{{- end -}}
{{- $seed := printf "%s|%s" $lang $seedBase -}}
{{- $idx := int (mod (crypto.FNV32a $seed) (len $list)) -}}
{{- $pick := index $list $idx -}}

<div class="comment-invite">
  <div class="comment-invite__title">{{ $pick.t }}</div>
  <div class="comment-invite__sub">{{ $pick.s }}</div>
</div>

<div class="comment-toggle">
  {{- if $hasWaline -}}
    <button id="btn-waline">Waline ğŸ’¬</button>
  {{- end -}}
  <button id="btn-giscus">Giscus ğŸ’¬</button>
</div>

{{/* ===== 3) Waline å®¹å™¨ ===== */}}
{{- if $hasWaline -}}
<div id="waline-container" class="comment-system">
  <div id="waline"></div>

  <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />

  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

    const serverURL = {{ $server | jsonify }};
    const commentPath = {{ $commentPath | jsonify }};

    init({
      el: '#waline',
      serverURL,
      path: commentPath,
      requiredMeta: ['nick', 'mail'],
      lang: {{ $walineLang | jsonify }},
      locale: { reactionTitle: "" },
      reaction: true,
      dark: 'body.dark',
    });
  </script>
</div>
{{- end -}}

{{/* ===== 4) Giscus å®¹å™¨ ===== */}}
<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
  <script src="https://giscus.app/client.js"
          data-repo="Liuqiran/liuqiran.github.io"
          data-repo-id="R_kgDONiVddQ"
          data-category="General"
          data-category-id="DIC_kwDONiVddc4CljSp"
          data-mapping="title"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="preferred_color_scheme"
          data-lang="{{ $giscusLang }}"
          crossorigin="anonymous"
          async>
  </script>
</div>

<script>
  const btnWaline = document.getElementById('btn-waline');
  const btnGiscus = document.getElementById('btn-giscus');
  const walineContainer = document.getElementById('waline-container');
  const giscusContainer = document.getElementById('giscus-container');

  function showWaline() {
    if (!btnWaline || !walineContainer) return;
    btnWaline.classList.add('active');
    btnGiscus.classList.remove('active');
    walineContainer.classList.add('active');
    giscusContainer.classList.remove('active');
    localStorage.setItem('preferredComment', 'waline');
  }

  function showGiscus() {
    btnGiscus.classList.add('active');
    if (btnWaline) btnWaline.classList.remove('active');
    giscusContainer.classList.add('active');
    if (walineContainer) walineContainer.classList.remove('active');
    localStorage.setItem('preferredComment', 'giscus');
  }

  if (btnWaline) btnWaline.onclick = showWaline;
  btnGiscus.onclick = showGiscus;

  window.addEventListener('DOMContentLoaded', () => {
    const preferred = localStorage.getItem('preferredComment');
    if (preferred === 'giscus') return showGiscus();
    if (btnWaline) return showWaline();
    showGiscus();
  });
</script>
