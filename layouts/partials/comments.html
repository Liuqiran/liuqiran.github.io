{{/* layouts/partials/comments.html */}}

{{- $langRaw := .Lang | lower -}}

{{/* ===== serverURLï¼ˆå¼ºåŠ›æ¸…æ´—ï¼‰===== */}}
{{- $server := "" -}}
{{- with site.Params.waline.serverURL -}}
  {{- $server = . -}}
{{- end -}}
{{- $server = $server | replaceRE `\\` "" -}}
{{- $server = $server | replaceRE `["']` "" -}}
{{- $server = $server | replaceRE `^\s+|\s+$` "" -}}
{{- $server = $server | replaceRE `/+$` "" -}}
{{- $hasWaline := ne $server "" -}}

{{/* ===== baseLangï¼šç”¨äº invite æ–‡æ¡ˆï¼ˆzh/en/jaï¼‰===== */}}
{{- $baseLang := "en" -}}
{{- if hasPrefix $langRaw "zh" -}}
  {{- $baseLang = "zh" -}}
{{- else if or (hasPrefix $langRaw "ja") (hasPrefix $langRaw "jp") -}}
  {{- $baseLang = "ja" -}}
{{- end -}}

{{/* ===== è¯­è¨€æ˜ å°„ï¼ˆç»™ data è¾“å‡ºä¸€ä¸ªé»˜è®¤å€¼ï¼›çœŸæ­£ä»¥ JS è¿è¡Œæ—¶ html lang ä¸ºå‡†ï¼‰===== */}}
{{- $walineLang := "en" -}}
{{- if eq $baseLang "zh" -}}
  {{- $walineLang = "zh-CN" -}}
{{- else if eq $baseLang "ja" -}}
  {{- $walineLang = "ja" -}}
{{- end -}}

{{/* ===== commentPathï¼šæ°¸è¿œ t:translationKeyï¼ˆæ²¡æœ‰å°±ç”¨æ–‡ä»¶åï¼‰===== */}}
{{- $tkey := "" -}}
{{- with .Params.translationKey -}}
  {{- $tkey = . -}}
{{- else -}}
  {{- with .File -}}{{- $tkey = .BaseFileName -}}{{- end -}}
{{- end -}}

{{- $tkey = $tkey | replaceRE `\\` "" -}}
{{- $tkey = $tkey | replaceRE `["']` "" -}}
{{- $tkey = $tkey | replaceRE `^\s+|\s+$` "" -}}

{{- $commentPath := printf "t:%s" $tkey -}}

<style>
.comment-toggle{ margin:1em 0; text-align:center; }
.comment-toggle button{
  padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
  border:1px solid var(--border, #ccc);
  background: var(--entry, #f8f8f8);
  color: var(--content, #555);
  font-weight:500; border-radius:8px; font-size:.9rem;
}
.comment-toggle button.active{
  background: var(--code-bg, #ddd);
  border-color: var(--border, #999);
  color: var(--content, #222);
  cursor:default; pointer-events:none;
}
.comment-system{ display:none; }
.comment-system.active{ display:block; }

/* ===== Invite copy ===== */
.comment-invite{ text-align:center; margin:1.2em 0 .6em; }
.comment-invite__title{ font-size:1rem; font-weight:500; }
.comment-invite__sub{ margin-top:.25em; font-size:.9rem; opacity:.75; }

#waline{
  --waline-theme-color: var(--primary);
  --waline-active-color: var(--primary);
  --waline-color: var(--content);
  --waline-bg-color: var(--entry);
  --waline-bg-color-light: var(--code-bg);
  --waline-border-color: var(--border);
  --waline-box-shadow: none;
}   

/* ===== Mobile FAB + TOC drawer (minimal JS) ===== */
.kq-fab{ display:none; }

@media (max-width: 900px){
  .kq-fab{
    position: fixed;
    right: calc(16px + env(safe-area-inset-right));
    bottom: calc(16px + env(safe-area-inset-bottom));
    display: none;
    flex-direction: row;      /* âœ… æ¨ªæ’ */
    gap: 12px;
    z-index: 9999;
  }
  .kq-fab.is-on{ display:flex; }

  /* âœ… ç»Ÿä¸€ä¸‰è€…å¤–è§‚ï¼šbutton + a.top-link */
  .kq-fab :is(.kq-fab-btn, .top-link){
    width: 44px;
    height: 44px;
    border-radius: 999px;
    border: 1px solid var(--border, #ccc);
    background: var(--entry, #fff);
    color: var(--content, #222);

    display: inline-flex;
    align-items: center;
    justify-content: center;

    transition: box-shadow 0.4s ease, transform 0.4s ease;
    box-shadow: 0px 2px 4px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
  }

  .kq-fab :is(.kq-fab-btn, .top-link):hover{
    box-shadow: 0px 4px 8px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
  }

  /* âœ… æŠŠ PaperMod çš„ top-link å›ºå®šå®šä½ç¦æ‰ï¼ˆå› ä¸ºç°åœ¨ç”± kq-fab å®¹å™¨è´Ÿè´£å®šä½ï¼‰ */
  .kq-fab .top-link{
    position: static !important;
    padding: 0 !important;
    text-decoration: none;
  }

  /* âœ… ä½  top.css é‡Œçš„ topInner ä¼šæœ‰ margin:7pxï¼Œæ¬è¿›æ¥åå»æ‰ï¼Œå¦åˆ™æŒ‰é’®ä¼šå˜å¤§ */
  .kq-fab .topInner{ margin: 0 !important; }
}

  /* æŠŠä½ ç°æœ‰çš„ #toc-container å˜æˆä¾§è¾¹æŠ½å±‰ */
  #toc-container{
    position: fixed;
    top: 0; right: -86vw;
    width: 86vw; max-width: 340px;
    height: 100vh;
    background: var(--theme, #fff);
    border-left: 1px solid var(--border, #ccc);
    box-shadow: -10px 0 30px rgba(0,0,0,.12);
    transition: right .18s ease;
    z-index: 9999;
  }
  html.kq-toc-open #toc-container{ right: 0; }

  /* è®© TOC å†…å®¹å¯æ‰‹æŒ‡æ»šåŠ¨ */
  #toc-container .inner{
    max-height: calc(100vh - 56px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* æ‰‹æœºä¸Šä¸€èˆ¬ä¸éœ€è¦ summaryï¼ˆå¦åˆ™ä¼šå ä¸€è¡Œï¼‰ï¼Œä½ æƒ³ä¿ç•™ä¹Ÿå¯ä»¥åˆ æ‰è¿™æ¡ */
  #toc-container summary{ display:none; }
  #toc-container details{ height:100%; }
}
</style>

{{/* ===== Invite æ–‡æ¡ˆï¼ˆæŒ‰è¯­è¨€éšæœºï¼Œä½†åŒä¸€é¡µç¨³å®šï¼‰===== */}}
{{- $invites := dict
  "zh" (slice
    (dict "t" "ä½ çš„ç•™è¨€ï¼Œæ˜¯æˆ‘ç»§ç»­å†™ä¸‹å»çš„åŠ¨åŠ› ğŸ‘‡" "s" "çŸ­å¥ä¹Ÿå¾ˆçè´µï¼Œæˆ‘ä¼šè®¤çœŸè¯»ã€‚")
    (dict "t" "å¦‚æœè¿™ç¯‡å¯¹ä½ æœ‰ä¸€ç‚¹å¸®åŠ©ï¼Œæ¬¢è¿ç•™ä¸€å¥è¯è®©æˆ‘çŸ¥é“ ğŸ‘‡" "s" "å“ªæ€•ä¸€ä¸ªè¡¨æƒ…ä¹Ÿå¯ä»¥ã€‚")
    (dict "t" "ä¸€å¥è¯å°±å¥½ï¼šä½ çœ‹å®Œæœ€å¤§çš„æ”¶è·æ˜¯ä»€ä¹ˆï¼ŸğŸ‘‡" "s" "æˆ‘æƒ³çŸ¥é“ä½ å¸¦èµ°äº†ä»€ä¹ˆã€‚")
    (dict "t" "çœ‹åˆ°ä½ å‚ä¸ï¼Œæˆ‘å°±çŸ¥é“è¿™ç¯‡æ²¡æœ‰ç™½å†™ ğŸ‘‡" "s" "è°¢è°¢ä½ æŠŠæ—¶é—´ç•™åœ¨è¿™é‡Œã€‚")
  )
  "en" (slice
    (dict "t" "Thanks for being hereâ€”this wasnâ€™t written into the void. ğŸ‘‡" "s" "I read every note.")
    (dict "t" "Your comment keeps me writing. ğŸ‘‡" "s" "Even a short note means a lot.")
    (dict "t" "One line is enough: whatâ€™s your biggest takeaway? ğŸ‘‡" "s" "Iâ€™d love to hear what you took from this.")
  )
  "ja" (slice
    (dict "t" "ã‚³ãƒ¡ãƒ³ãƒˆãŒã€æ›¸ãç¶šã‘ã‚‹åŠ›ã«ãªã‚Šã¾ã™ ğŸ‘‡" "s" "çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚å…¨éƒ¨èª­ã¿ã¾ã™ã€‚")
    (dict "t" "å°‘ã—ã§ã‚‚å½¹ã«ç«‹ã£ãŸã‚‰ã€ä¸€è¨€ã ã‘ã§ã‚‚æ®‹ã—ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ã§ã™ ğŸ‘‡" "s" "çµµæ–‡å­—ã ã‘ã§ã‚‚OKã§ã™ã€‚")
  )
-}}

{{- $list := index $invites $baseLang -}}
{{- if not $list -}}{{- $list = index $invites "en" -}}{{- end -}}

{{- $seedBase := .RelPermalink -}}
{{- with .File -}}{{- $seedBase = .Path -}}{{- end -}}
{{- $seed := printf "%s|%s" $baseLang $seedBase -}}
{{- $idx := int (mod (crypto.FNV32a $seed) (len $list)) -}}
{{- $pick := index $list $idx -}}

<div class="comment-invite">
  <div class="comment-invite__title">{{ $pick.t }}</div>
  <div class="comment-invite__sub">{{ $pick.s }}</div>
</div>

<div class="comment-toggle">
  {{- if $hasWaline -}}<button id="btn-waline" type="button">Waline ğŸ’¬</button>{{- end -}}
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

{{- if $hasWaline -}}
<div id="waline-container" class="comment-system">
  <div id="waline"></div>
  <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />

<script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

  // âœ… æŠŠ Hugo å˜é‡å–‚ç»™ JSï¼ˆå¦åˆ™ serverURL/commentPath éƒ½æ˜¯ undefinedï¼‰
  const serverURL = {{ $server | jsonify }};
  const commentPath = {{ $commentPath | jsonify }};
  const hugoDefaultLang = {{ $walineLang | jsonify }};


  function normalizeWalineLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "jp";
    return "en";
  }

  const rawHtmlLang = document.documentElement.lang || hugoDefaultLang || "en";
  const pageLang = normalizeWalineLang(rawHtmlLang);

  const placeholderMap = {
    "zh-CN": "çœ‹åˆ°ä½ å‚ä¸ï¼Œæˆ‘å°±çŸ¥é“è¿™ç¯‡æ²¡æœ‰ç™½å†™ã€‚è°¢è°¢ä½ æŠŠæ—¶é—´ç•™åœ¨è¿™é‡Œã€‚",
    "en": "Thanks for being hereâ€”this wasnâ€™t written into the void. I read every note.",
    "jp": "æ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ã­ ğŸ‘‡",
  };

  const placeholder =
    placeholderMap[pageLang] ||
    placeholderMap[pageLang.split("-")[0]] ||
    "Comment here...";

  let walineInited = false;
  function ensureWaline() {
    if (walineInited) return;
    walineInited = true;

    init({
      el: "#waline",
      serverURL,
      path: commentPath,
      requiredMeta: ["nick", "mail"],

      lang: pageLang,
      locale: {
        reactionTitle: "",
        placeholder,
      },

      reaction: true,
      dark: "body.dark",
      imageUploader: false,
    });

    console.log("[Waline] inited:", { serverURL, commentPath, pageLang });
  }

  window.__ensureWaline = ensureWaline;
</script> 
</div>
{{- end -}}

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

<div class="kq-toc-overlay" id="kq-toc-overlay" aria-hidden="true"></div>

<div class="kq-fab" id="kq-fab">
  <button class="kq-fab-btn" id="kq-fab-toc" type="button">â˜°</button>
  <button class="kq-fab-btn" id="kq-fab-cmt" type="button">ğŸ’¬</button>
</div>


<script>
  const btnWaline = document.getElementById('btn-waline');
  const btnGiscus = document.getElementById('btn-giscus');
  const walineContainer = document.getElementById('waline-container');
  const giscusContainer = document.getElementById('giscus-container');

  const GISCUS_TERM = {{ $commentPath | jsonify }};
  const GISCUS_REPO = "Liuqiran/liuqiran.github.io";
  const GISCUS_REPO_ID = "R_kgDONiVddQ";
  const GISCUS_CATEGORY = "General";
  const GISCUS_CATEGORY_ID = "DIC_kwDONiVddc4CljSp";

  function normalizeLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "ja";
    return "en";
  }

 let giscusLoaded = false;
function ensureGiscus() {
  if (giscusLoaded) return;
  giscusLoaded = true;

  const lang = normalizeLang(document.documentElement.lang);
  const host = document.getElementById('giscus-comment');
  if (!host) return;

  const s = document.createElement('script');
  s.src = 'https://giscus.app/client.js';
  s.async = true;
  s.crossOrigin = 'anonymous';

  s.setAttribute('data-repo', GISCUS_REPO);
  s.setAttribute('data-repo-id', GISCUS_REPO_ID);
  s.setAttribute('data-category', GISCUS_CATEGORY);
  s.setAttribute('data-category-id', GISCUS_CATEGORY_ID);
  s.setAttribute('data-mapping', 'specific');
  s.setAttribute('data-term', GISCUS_TERM);
  s.setAttribute('data-strict', '0');
  s.setAttribute('data-reactions-enabled', '1');
  s.setAttribute('data-emit-metadata', '0');
  s.setAttribute('data-input-position', 'bottom');
  s.setAttribute('data-theme', 'preferred_color_scheme');
  s.setAttribute('data-lang', lang);

  host.appendChild(s);
}

function showWaline() {
  if (!btnWaline || !walineContainer) return;
  btnWaline.classList.add('active');
  if (btnGiscus) btnGiscus.classList.remove('active');
  walineContainer.classList.add('active');
  if (giscusContainer) giscusContainer.classList.remove('active');
  localStorage.setItem('preferredComment', 'waline');
  if (window.__ensureWaline) window.__ensureWaline();
}
function showGiscus() {
  if (!btnGiscus || !giscusContainer) return;
  btnGiscus.classList.add('active');
  if (btnWaline) btnWaline.classList.remove('active');
  giscusContainer.classList.add('active');
  if (walineContainer) walineContainer.classList.remove('active');
  localStorage.setItem('preferredComment', 'giscus');
  ensureGiscus();
}

window.__kqShowWaline = showWaline;
window.__kqShowGiscus = showGiscus;

if (btnWaline) btnWaline.onclick = showWaline;
if (btnGiscus) btnGiscus.onclick = showGiscus;

window.addEventListener('DOMContentLoaded', () => {
  const preferred = localStorage.getItem('preferredComment');
  if (!btnWaline || !walineContainer) return showGiscus();
  if (preferred === 'giscus') return showGiscus();
  return showWaline();
});
</script>  

<script>
(() => {
  const html = document.documentElement;

  const fab = document.getElementById('kq-fab');
  const btnTOC = document.getElementById('kq-fab-toc');
  const btnCmt = document.getElementById('kq-fab-cmt');
  const overlay = document.getElementById('kq-toc-overlay');

  const toc = document.getElementById('toc-container');

  function enableFab() {
    if (fab) fab.classList.add('is-on');
  }

  // åªæœ‰â€œè¯„è®ºå¼€å¯/æ˜¾ç¤ºâ€æ—¶å†å‡ºç° FABï¼šä½ è¿™é¡µé»˜è®¤ä¼š showWaline/showGiscusï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å¯ç”¨å³å¯
  window.addEventListener('DOMContentLoaded', enableFab);

  // æ²¡ TOC å°±éšè— â˜°
  if (!toc && btnTOC) btnTOC.remove();

  function openTOC() {
    if (!toc) return;
    html.classList.add('kq-toc-open');
    // å¤ç”¨ä½  TOC é‡Œçš„ <details>ï¼Œæ‰“å¼€å®ƒä»¥ä¾¿æ¸²æŸ“ ul
    const d = toc.querySelector('details');
    if (d) d.open = true;
  }
  function closeTOC() {
    html.classList.remove('kq-toc-open');
  }

  btnTOC && btnTOC.addEventListener('click', openTOC);
  overlay && overlay.addEventListener('click', closeTOC);

  // ç‚¹ç›®å½•é¡¹ï¼šè·³è½¬åè‡ªåŠ¨éšè—æŠ½å±‰ï¼ˆ1 ä¸ªç›‘å¬ï¼‰
  toc && toc.addEventListener('click', (e) => {
    const a = e.target.closest('a[href^="#"]');
    if (!a) return;
    closeTOC();
  });

  // ğŸ’¬ï¼šåˆ‡åˆ°ä¸Šæ¬¡è¯„è®ºç³»ç»Ÿ + æ»šåˆ°è¾“å…¥æ¡†
  btnCmt && btnCmt.addEventListener('click', () => {
    closeTOC();

    const preferred = localStorage.getItem('preferredComment'); // ä½ ç°æœ‰é€»è¾‘
    const hasWaline = !!document.getElementById('waline-container');
    const hasGiscus = !!document.getElementById('giscus-container');

    if (preferred === 'giscus' && hasGiscus && window.__kqShowGiscus) window.__kqShowGiscus();
    else if (hasWaline && window.__kqShowWaline) window.__kqShowWaline();
    else if (hasGiscus && window.__kqShowGiscus) window.__kqShowGiscus();

    const target = document.getElementById('waline') || document.getElementById('giscus-comment');
    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // å°½é‡ focus Waline è¾“å…¥æ¡†ï¼ˆWaline æ‡’åŠ è½½æ—¶éœ€è¦ç­‰ä¸€ä¸‹ï¼‰
    let tries = 0;
    (function tryFocus() {
      tries++;
      const host = document.getElementById('waline');
      if (!host) return;

      const ta = host.querySelector('textarea');
      if (ta) { ta.focus({ preventScroll: true }); return; }

      const ed = host.querySelector('[contenteditable="true"]');
      if (ed) { ed.focus({ preventScroll: true }); return; }

      if (tries < 30) requestAnimationFrame(tryFocus);
    })();
  });
})();
</script>

