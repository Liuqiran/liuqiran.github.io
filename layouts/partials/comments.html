{{/* layouts/partials/comments.html */}}

{{- $langRaw := .Lang | lower -}}

{{/* ===== serverURLï¼ˆæ¨¡æ¿ä¾§æ¸…æ´—ï¼‰===== */}}
{{- $server := "" -}}
{{- with site.Params.waline.serverURL -}}
  {{- $server = . -}}
{{- end -}}
{{- $server = $server | replaceRE `\\` "" -}}
{{- $server = $server | replaceRE `["']` "" -}}
{{- $server = $server | replaceRE `^\s+|\s+$` "" -}}
{{- $server = $server | replaceRE `/+$` "" -}}
{{- $hasWaline := ne $server "" -}}

{{/* ===== walineLang å…œåº•ï¼ˆçœŸæ­£ä»¥ <html lang> ä¸ºå‡†ï¼‰===== */}}
{{- $walineLang := "en" -}}
{{- if hasPrefix $langRaw "zh" -}}
  {{- $walineLang = "zh-CN" -}}
{{- else if or (hasPrefix $langRaw "ja") (hasPrefix $langRaw "jp") -}}
  {{- $walineLang = "jp" -}}
{{- end -}}

{{/* ===== tkeyï¼ˆtranslationKey -> BaseFileNameï¼‰===== */}}
{{- $tkey := "" -}}
{{- with .Params.translationKey -}}
  {{- $tkey = . -}}
{{- else -}}
  {{- with .File -}}{{- $tkey = .BaseFileName -}}{{- end -}}
{{- end -}}
{{- $tkey = $tkey | replaceRE `\\` "" -}}
{{- $tkey = $tkey | replaceRE `["']` "" -}}
{{- $tkey = $tkey | replaceRE `^\s+|\s+$` "" -}}
{{- $legacyPath := printf "t:%s" $tkey -}}

{{/* ===== canonicalï¼šå›ºå®šç”¨è‹±æ–‡é¡µé¢çš„ RelPermalinkï¼ˆè®©å¤šè¯­è¨€å…±ç”¨ä¸€æ¡çº¿ç¨‹ï¼Œå¹¶ä¸” /en/... å¯æ‰“å¼€ï¼‰===== */}}
{{- $canonicalRel := .RelPermalink -}}
{{- range .AllTranslations -}}
  {{- if eq .Lang "en" -}}
    {{- $canonicalRel = .RelPermalink -}}
  {{- end -}}
{{- end -}}
{{- $canonicalRel = $canonicalRel | replaceRE `/$` "" -}}
{{- if eq $canonicalRel "" -}}{{- $canonicalRel = "/" -}}{{- end -}}

{{/* ===== noPrefixï¼šç”¨äºå…¼å®¹ä½ è¿‡æ¸¡æœŸå·²ç»å†™å…¥çš„â€œå»è¯­è¨€å‰ç¼€â€çº¿ç¨‹ï¼ˆ/reading-listï¼‰===== */}}
{{- $noPrefixRel := $canonicalRel | replaceRE `^/(en|zh|ja)(/|$)` "/" -}}
{{- $noPrefixRel = $noPrefixRel | replaceRE `/$` "" -}}
{{- if eq $noPrefixRel "" -}}{{- $noPrefixRel = "/" -}}{{- end -}}

{{/* ===== åªæ”¹â€œæ–°æ–‡ç« â€çš„ pathï¼šä»è¿™ä¸ªæ—¥æœŸèµ·ç”¨ canonicalï¼ˆä½ å¯æ”¹ï¼‰===== */}}
{{- $cutover := time "2025-12-29T00:00:00+08:00" -}}
{{- $isNew := ge .Date $cutover -}}

{{/* é»˜è®¤ pathï¼šæ—§æ–‡ç«  legacyï¼›æ–°æ–‡ç«  canonical */}}
{{- $commentPath := $legacyPath -}}
{{- if $isNew -}}
  {{- $commentPath = $canonicalRel -}}
{{- end -}}

{{/* æœ€åå†åšä¸€æ¬¡â€œé¿å‘æ¸…æ´—â€ */}}
{{- $commentPath = $commentPath | replaceRE `\\` "" -}}
{{- $commentPath = $commentPath | replaceRE `["']` "" -}}
{{- $commentPath = $commentPath | replaceRE `^\s+|\s+$` "" -}}

<style>
/* ===== Toggle ===== */
.comment-toggle{ margin:1em 0; text-align:center; }
.comment-toggle button{
  padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
  border:1px solid var(--border, #ccc);
  background: var(--entry, #f8f8f8);
  color: var(--content, #555);
  font-weight:500; border-radius:8px; font-size:.9rem;
}
.comment-toggle button.active{
  background: var(--code-bg, #ddd);
  border-color: var(--border, #999);
  color: var(--content, #222);
  cursor:default; pointer-events:none;
}
.comment-system{ display:none; }
.comment-system.active{ display:block; }

/* ===== Waline theme ===== */
#waline{
  --waline-theme-color: var(--primary);
  --waline-active-color: var(--primary);
  --waline-color: var(--content);
  --waline-bg-color: var(--entry);
  --waline-bg-color-light: var(--code-bg);
  --waline-border-color: var(--border);
  --waline-box-shadow: none;
}

/* ===== FABï¼ˆTOC + Commentsï¼›ç§»åŠ¨ç«¯æŠŠ Top æ”¶è¿›åŒä¸€åˆ—ï¼‰ ===== */
.kq-fab{
  --kq-fab-bottom: 16px;
  --kq-fab-gap: 12px;

  position: fixed;
  right: calc(16px + env(safe-area-inset-right));
  bottom: calc(var(--kq-fab-bottom) + env(safe-area-inset-bottom));

  display: none;
  flex-direction: column;
  gap: var(--kq-fab-gap);
  z-index: 9999;
}
.kq-fab.is-on{ display:flex; }

/* æ¡Œé¢ç«¯ï¼štop-link é¡¶åˆ° FAB ä¸Šæ–¹ */
html.kq-fab-on a.top-link{
  right: calc(16px + env(safe-area-inset-right)) !important;
  bottom: calc(
    var(--kq-fab-bottom, 16px)
    + env(safe-area-inset-bottom)
    + var(--kq-fab-h, 0px)
    + var(--kq-fab-gap, 12px)
  ) !important;
}

/* æ‰‹æœºï¼šåªæ”¹å˜é‡ï¼Œä¸å†™æ­» bottom */
@media (max-width: 900px){
}

.kq-fab-btn{
  width: 44px; height: 44px;
  border-radius: 999px;
  border: 1px solid var(--border, #ccc);
  background: var(--entry, #fff);
  color: var(--content, #222);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  box-shadow: 0px 2px 4px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
}
.kq-fab-btn:hover{
  box-shadow: 0px 4px 8px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
}

/* âœ… åªå½±å“â€œè¢«å¡è¿› FAB çš„ top-linkâ€ï¼Œä¸åŠ¨ä½ åŸ Top.css */
.kq-fab a.top-link.kq-top-in-fab{
  position: static !important;
  right: auto !important;
  bottom: auto !important;

  width: 44px !important;
  height: 44px !important;
  padding: 0 !important;
  margin: 0 !important;

  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 999px !important;
}

/* ===== iPhone å®‰å…¨åŒº + æ‰‹æœº TOC æŠ½å±‰ï¼ˆåŒæ—¶å…¼å®¹æ²¡æœ‰ id çš„æƒ…å†µï¼‰ ===== */
@media (max-width: 900px){
  #toc-container,
  aside.toc-container,
  .toc-container{
    position: fixed !important;
    top: 0 !important;
    right: -100% !important;
    left: auto !important;
    bottom: 0 !important;

    width: min(86vw, 360px) !important;
    height: 100% !important;

    background: var(--theme);
    border-left: 1px solid var(--border);
    padding: calc(12px + env(safe-area-inset-top)) 12px 12px;

    transition: right .18s ease;
    z-index: 9999;
  }

  html.kq-toc-open #toc-container,
  html.kq-toc-open aside.toc-container,
  html.kq-toc-open .toc-container{
    right: 0 !important;
  }

  #toc-container .inner,
  .toc-container .inner{
    max-height: calc(100vh - 56px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  html.kq-toc-open .kq-toc-overlay{
    opacity: 1;
    pointer-events: auto;
  }

  .kq-fab a.top-link.kq-top-in-fab .topInner{
    margin: 0 !important;
    display: grid !important;
    place-items: center !important;
    gap: 1px !important;
  }

  .kq-fab a.top-link.kq-top-in-fab #read_progress{
    display: block !important;
    width: 100% !important;
    text-align: center !important;

    white-space: nowrap !important;
    overflow-wrap: normal !important;
    word-break: keep-all !important;

    font-variant-numeric: tabular-nums lining-nums;
    font-feature-settings: "tnum" 1, "lnum" 1;

    font-size: 14px !important;
    line-height: 1 !important;
    letter-spacing: -0.14em !important;
    transform: translateX(-0.5px);
  }
}
</style>

<div class="comment-toggle">
  {{- if $hasWaline -}}<button id="btn-waline" type="button">Waline ğŸ’¬</button>{{- end -}}
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

{{- if $hasWaline -}}
<div id="waline-container" class="comment-system">
  <div id="waline"></div>
</div>
{{- end -}}

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

<div class="kq-toc-overlay" id="kq-toc-overlay" aria-hidden="true"></div>

<div class="kq-fab" id="kq-fab">
  <button class="kq-fab-btn" id="kq-fab-toc" type="button" aria-label="TOC">â˜°</button>
  <button class="kq-fab-btn" id="kq-fab-cmt" type="button" aria-label="Comments">ğŸ’¬</button>
</div>

<script>
(() => {
  // ====== ä» Hugo ä¼ å€¼è¿›æ¥ ======
  const HAS_WALINE = {{ $hasWaline | jsonify }};
  const HUGO_SERVER_RAW = {{ $server | jsonify }};
  const HUGO_PATH_RAW = {{ $commentPath | jsonify }};
  const HUGO_CANON_REL = {{ $canonicalRel | jsonify }};
  const HUGO_NOPREFIX_REL = {{ $noPrefixRel | jsonify }};
  const HUGO_LEGACY = {{ $legacyPath | jsonify }};
  const HUGO_IS_NEW = {{ $isNew | jsonify }};
  const HUGO_LANG_FALLBACK = {{ $walineLang | jsonify }};

  // ====== DOM ======
  const btnWaline = document.getElementById('btn-waline');
  const btnGiscus = document.getElementById('btn-giscus');
  const walineContainer = document.getElementById('waline-container');
  const giscusContainer = document.getElementById('giscus-container');

  const fab = document.getElementById('kq-fab');
  const btnTOC = document.getElementById('kq-fab-toc');
  const btnCmt = document.getElementById('kq-fab-cmt');
  const overlay = document.getElementById('kq-toc-overlay');
  const toc = document.getElementById('toc-container')
    || document.querySelector('aside.toc-container, .toc-container, .toc');
  const mqMobile = window.matchMedia('(max-width: 900px)');

  // ====== helpers ======
  function cleanString(x){
    return String(x ?? "").replace(/\\/g, "").replace(/["']/g, "").trim();
  }
  function cleanServerURL(x){
    let s = cleanString(x).replace(/\/+$/, "");
    s = s.replace(/^(https?:\/\/)(https?:\/\/)+/i, "$1");
    const ms = s.match(/https?:\/\//ig);
    if (ms && ms.length > 1) s = s.slice(s.toLowerCase().lastIndexOf("http"));
    if (s.startsWith("//")) s = "https:" + s;
    return s.replace(/\/+$/, "");
  }
  function isValidHttpUrl(s){
    try{
      const u = new URL(s);
      return u.protocol === "http:" || u.protocol === "https:";
    }catch(e){ return false; }
  }
  function deferLoad(fn) {
    if ('requestIdleCallback' in window) requestIdleCallback(fn, { timeout: 1200 });
    else setTimeout(fn, 250);
  }

  // ====== Lang normalize ======
  function normalizeWalineLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "jp";
    return "en";
  }
  function normalizeGiscusLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "ja";
    return "en";
  }

  // ====== Waline (æ‡’åŠ è½½ + å¤š CDN å…œåº•) ======
  let walineReady = false;
  let walineLoading = null;
  let walineModulePromise = null;

  const serverURL = cleanServerURL(HUGO_SERVER_RAW);

  const legacyPath = cleanString(HUGO_LEGACY);
  const canonRel = cleanString(HUGO_CANON_REL);       // /en/xxx
  const noPrefixRel = cleanString(HUGO_NOPREFIX_REL); // /xxx
  const isNew = !!HUGO_IS_NEW;

  const pageLangWaline = normalizeWalineLang(document.documentElement.lang || HUGO_LANG_FALLBACK || "en");

  const walineOK = HAS_WALINE && walineContainer && isValidHttpUrl(serverURL);
  if (!walineOK) window.__walineBadConfig = true;

  const PLACEHOLDER_MAP = {
    "zh-CN": "å½“æœˆå…‰æ´’ä¸‹ï¼Œä¸‡ç‰©çš†æ˜¯ä½è¯­ï¼Œä½ å¬åˆ°äº†ä»€ä¹ˆå¿ƒäº‹ï¼Ÿ",
    "jp": "ã‚³ãƒ¡ãƒ³ãƒˆã©ã†ãâ€¦(*^_^*)",
    "en": "My words are just an invitation; your thoughts are the destination.",
  };
  const myPlaceholder = PLACEHOLDER_MAP[pageLangWaline] || "Write a commentâ€¦";

  // âœ… å¤š CDNï¼šä¼˜å…ˆå›½å†…æ›´ç¨³çš„ elemecdnï¼Œå…¶æ¬¡ jsDelivrï¼Œå† unpkg
  const WALINE_CSS_CANDIDATES = [
    "https://npm.elemecdn.com/@waline/client@v3/dist/waline.css",
    "https://cdn.jsdelivr.net/npm/@waline/client@3/dist/waline.css",
    "https://unpkg.com/@waline/client@v3/dist/waline.css",
  ];
  const WALINE_JS_CANDIDATES = [
    "https://npm.elemecdn.com/@waline/client@v3/dist/waline.js",
    "https://cdn.jsdelivr.net/npm/@waline/client@3/dist/waline.js",
    "https://unpkg.com/@waline/client@v3/dist/waline.js",
  ];

  function loadCSSFromCandidatesOnce() {
    if (document.getElementById('kq-waline-css')) return Promise.resolve(true);

    return new Promise((resolve) => {
      let i = 0;
      const tryNext = () => {
        if (i >= WALINE_CSS_CANDIDATES.length) return resolve(false);

        const href = WALINE_CSS_CANDIDATES[i++];
        const link = document.createElement('link');
        link.id = 'kq-waline-css';
        link.rel = 'stylesheet';
        link.href = href;

        link.onload = () => resolve(true);
        link.onerror = () => {
          link.remove();
          tryNext();
        };

        document.head.appendChild(link);
      };

      tryNext();

      // å¯é€‰ï¼šé˜²æ­¢ä¸»é¢˜æŠŠ placeholder é€æ˜åº¦å‹æ²¡
      if (!document.getElementById('kq-waline-ph-style')) {
        const st = document.createElement('style');
        st.id = 'kq-waline-ph-style';
        st.textContent = `
          #waline textarea::placeholder,
          #waline input::placeholder { opacity: .85; }
        `;
        document.head.appendChild(st);
      }
    });
  }

  async function importWalineFromCandidates() {
    let lastErr = null;
    for (const url of WALINE_JS_CANDIDATES) {
      try {
        const mod = await import(url);
        if (mod && typeof mod.init === "function") return mod;
        lastErr = new Error("Waline module invalid: " + url);
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error("Waline import failed");
  }

  function warmWalineAssets(){
    if (!walineOK) return;
    loadCSSFromCandidatesOnce();
    if (!walineModulePromise) walineModulePromise = importWalineFromCandidates();
  }

  async function fetchWithTimeout(url, ms=900) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, { signal: ctrl.signal, credentials: "omit" });
      return res;
    } finally {
      clearTimeout(t);
    }
  }

  async function hasAnyComment(path) {
    if (!path) return false;
    try {
      const u = `${serverURL}/api/comment?path=${encodeURIComponent(path)}&pageSize=1`;
      const res = await fetchWithTimeout(u, 900);
      if (!res.ok) return false;
      const data = await res.json();
      const arr = data?.data || data?.comments || data;
      return Array.isArray(arr) ? arr.length > 0 : !!data?.data?.length;
    } catch (e) {
      return false;
    }
  }

  async function resolveFinalPath() {
    // æ—§æ–‡ç« ï¼šå›ºå®š legacyï¼ˆä¸æ¢æµ‹ï¼Œæœ€å¿«ä¸”ä¿è¯æ—§è¯„è®ºï¼‰
    if (!isNew) return legacyPath;

    // æ–°æ–‡ç« ï¼šé»˜è®¤ canonical(/en/...)ï¼Œä½†å…¼å®¹ä½ è¿‡æ¸¡æœŸå†™å…¥çš„ noPrefix(/xxx)
    const cacheKey = "kq_waline_path_choice::" + canonRel;
    const cached = localStorage.getItem(cacheKey);
    if (cached) return cached;

    // åªæ¢æµ‹ä¸€æ¬¡ï¼šå¦‚æœ noPrefix å·²ç»æœ‰è¯„è®ºï¼Œå°±ç»§ç»­ç”¨å®ƒï¼ˆé¿å…â€œè¯„è®ºçªç„¶æ²¡äº†â€ï¼‰
    const useNoPrefix = await hasAnyComment(noPrefixRel);
    const chosen = useNoPrefix ? noPrefixRel : canonRel;

    try { localStorage.setItem(cacheKey, chosen); } catch(e){}
    return chosen;
  }

  async function ensureWaline() {
    if (!walineOK || walineReady) return;
    if (walineLoading) return;

    walineLoading = (async () => {
      warmWalineAssets();

      const finalPath = await resolveFinalPath();
      const mod = walineModulePromise ? await walineModulePromise : await importWalineFromCandidates();
      await loadCSSFromCandidatesOnce();

      mod.init({
        el: "#waline",
        serverURL,
        path: finalPath,
        requiredMeta: ["nick", "mail"],
        lang: pageLangWaline,
        locale: {
          placeholder: myPlaceholder,
          reactionTitle: "",
        },
        reaction: true,
        dark: "body.dark",
        imageUploader: false,
      });

      walineReady = true;
      walineLoading = null;
      console.log("[Waline] inited:", { serverURL, finalPath, canonRel, noPrefixRel, legacyPath, pageLangWaline });
    })().catch((e) => {
      console.error("[Waline] init failed:", e);
      window.__walineBadConfig = true;
      walineLoading = null;
      showGiscus(true);
    });
  }

  // ====== Giscus æ‡’åŠ è½½ ======
  const GISCUS_REPO = "Liuqiran/liuqiran.github.io";
  const GISCUS_REPO_ID = "R_kgDONiVddQ";
  const GISCUS_CATEGORY = "General";
  const GISCUS_CATEGORY_ID = "DIC_kwDONiVddc4CljSp";
  const giscusTerm = cleanString(HUGO_PATH_RAW);

  let giscusLoaded = false;
  function ensureGiscus() {
    if (giscusLoaded) return;
    giscusLoaded = true;

    const lang = normalizeGiscusLang(document.documentElement.lang);
    const host = document.getElementById('giscus-comment');
    if (!host) return;
    host.innerHTML = "";

    const s = document.createElement('script');
    s.src = 'https://giscus.app/client.js';
    s.async = true;
    s.crossOrigin = 'anonymous';

    s.setAttribute('data-repo', GISCUS_REPO);
    s.setAttribute('data-repo-id', GISCUS_REPO_ID);
    s.setAttribute('data-category', GISCUS_CATEGORY);
    s.setAttribute('data-category-id', GISCUS_CATEGORY_ID);
    s.setAttribute('data-mapping', 'specific');
    s.setAttribute('data-term', giscusTerm);
    s.setAttribute('data-strict', '0');
    s.setAttribute('data-reactions-enabled', '1');
    s.setAttribute('data-emit-metadata', '0');
    s.setAttribute('data-input-position', 'bottom');
    s.setAttribute('data-theme', 'preferred_color_scheme');
    s.setAttribute('data-lang', lang);

    host.appendChild(s);
    console.log("[Giscus] loaded:", { giscusTerm, lang });
  }

  // ====== UI åˆ‡æ¢ ======
  function showWaline(loadNow=true) {
    if (!walineOK) return showGiscus(loadNow);

    if (btnWaline) btnWaline.classList.add('active');
    if (btnGiscus) btnGiscus.classList.remove('active');

    if (walineContainer) walineContainer.classList.add('active');
    if (giscusContainer) giscusContainer.classList.remove('active');

    localStorage.setItem('preferredComment', 'waline');
    if (loadNow) ensureWaline();
  }

  function showGiscus(loadNow=true) {
    if (btnGiscus) btnGiscus.classList.add('active');
    if (btnWaline) btnWaline.classList.remove('active');

    if (giscusContainer) giscusContainer.classList.add('active');
    if (walineContainer) walineContainer.classList.remove('active');

    localStorage.setItem('preferredComment', 'giscus');
    if (loadNow) ensureGiscus();
  }

  window.__kqShowWaline = () => showWaline(true);
  window.__kqShowGiscus = () => showGiscus(true);

  if (btnWaline) btnWaline.onclick = () => showWaline(true);
  if (btnGiscus) btnGiscus.onclick = () => showGiscus(true);

  // é¦–å±ï¼šå…ˆåˆ‡ UIï¼Œä¸ç«‹åˆ»åŠ è½½ï¼›ç©ºé—²é¢„çƒ­ + åŠ è½½
  window.addEventListener('DOMContentLoaded', () => {
    const preferred = localStorage.getItem('preferredComment');

    if (!walineOK) {
      showGiscus(false);
      deferLoad(() => ensureGiscus());
    } else if (preferred === 'giscus') {
      showGiscus(false);
      deferLoad(() => ensureGiscus());
    } else {
      showWaline(false);
      // âœ… é¢„çƒ­èµ„æºï¼šè®©â€œç‚¹å¼€è¯„è®ºâ€æ›´å¿«
      deferLoad(() => warmWalineAssets());
      deferLoad(() => ensureWaline());
    }
  });

  // ====== FABï¼šTOC / Comments ======
  function closeTOC(){
    document.documentElement.classList.remove('kq-toc-open');
    if (toc) {
      const d = toc.querySelector('details');
      if (d) d.open = false;
    }
  }

  function openTOC(){
    if (!toc) return;
    const d = toc.querySelector('details');
    if (d) d.open = true;

    if (mqMobile.matches) {
      document.documentElement.classList.add('kq-toc-open');
    } else {
      toc.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function toggleTOC(){
    const html = document.documentElement;
    if (html.classList.contains('kq-toc-open')) closeTOC();
    else openTOC();
  }

  btnTOC && btnTOC.addEventListener('click', toggleTOC);
  overlay && overlay.addEventListener('click', closeTOC);
  overlay && overlay.addEventListener('touchstart', closeTOC, { passive: true });

  toc && toc.addEventListener('click', (e) => {
    const a = e.target.closest('a[href^="#"]');
    if (a && mqMobile.matches) closeTOC();
  });

  btnCmt && btnCmt.addEventListener('click', () => {
    closeTOC();

    const preferred = localStorage.getItem('preferredComment');
    const canWaline = walineContainer && walineOK;
    const canGiscus = !!giscusContainer;

    if (preferred === 'giscus' && canGiscus) showGiscus(true);
    else if (canWaline) showWaline(true);
    else if (canGiscus) showGiscus(true);

    const active = document.querySelector('.comment-system.active');
    const target =
      (active && (active.querySelector('#waline') || active.querySelector('#giscus-comment'))) ||
      document.getElementById('waline') ||
      document.getElementById('giscus-comment');

    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  window.addEventListener('DOMContentLoaded', () => {
    if (!fab) return;

    if (!toc && btnTOC) btnTOC.remove();

    const hasAnyComment = (walineContainer && walineOK) || !!giscusContainer;
    if (!hasAnyComment && btnCmt) btnCmt.remove();

    const hasAnyControl = !!fab.querySelector('button, a');
    const html = document.documentElement;

    function syncFabOffset(){
      const h = fab ? fab.getBoundingClientRect().height : 0;
      html.style.setProperty('--kq-fab-h', h ? `${Math.ceil(h)}px` : '0px');
    }

    if (hasAnyControl) {
      fab.classList.add('is-on');
      html.classList.add('kq-fab-on');

      const topLink = document.querySelector('a.top-link');
      let topLinkHome = null;
      let topLinkNext = null;

      function syncTopLinkPlacement(){
        if (!topLink) return;

        if (mqMobile.matches) {
          if (!fab.contains(topLink)) {
            topLinkHome = topLinkHome || topLink.parentElement;
            topLinkNext = topLinkNext || topLink.nextSibling;

            topLink.classList.add('kq-top-in-fab');
            fab.appendChild(topLink);
          }
        } else {
          if (topLinkHome && topLink.classList.contains('kq-top-in-fab')) {
            topLink.classList.remove('kq-top-in-fab');
            topLinkHome.insertBefore(topLink, topLinkNext);
          }
        }

        requestAnimationFrame(syncFabOffset);
      }

      syncTopLinkPlacement();
      mqMobile.addEventListener('change', syncTopLinkPlacement);

      requestAnimationFrame(syncFabOffset);

      window.addEventListener('resize', () => {
        if (html.classList.contains('kq-fab-on')) requestAnimationFrame(syncFabOffset);
      }, { passive: true });
    } else {
      fab.classList.remove('is-on');
      html.classList.remove('kq-fab-on');
      syncFabOffset();
    }
  });
})();
</script>
