<style>
  .comment-toggle { margin-bottom: 1em; text-align: center; }
  .comment-toggle button {
    padding: 0.5em 1.2em; margin: 0 0.3em; cursor: pointer;
    border: 1px solid #ccc; background: #f8f8f8; color: #555;
    font-weight: 500; border-radius: 4px; font-size: 0.9rem;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
  }
  .comment-toggle button:hover { background: #e2e2e2; border-color: #999; color: #333; }
  .comment-toggle button.active {
    background: #ccc; border-color: #999; color: #222;
    cursor: default; pointer-events: none;
  }
  .comment-system { display: none; }
  .comment-system.active { display: block; }

  /* è®©è¯„è®ºåŒºç»§æ‰¿æ­£æ–‡é£æ ¼ï¼ˆæŒ‰ä½ çš„éœ€è¦ä¿ç•™/ä¿®æ”¹ï¼‰ */
  html[lang="en-US"] .comment-system, html[lang="en-US"] .comment-system * {
    font-family: "Georgia", "Times New Roman", serif !important;
    font-size: 1rem !important;
    font-weight: 400 !important;
    line-height: 1.6 !important;
  }
  html[lang="zh-CN"] .comment-system, html[lang="zh-CN"] .comment-system * {
    font-family: 'KingHwa_OldSong', sans-serif !important;
    font-size: 1rem !important;
    font-weight: 400 !important;
    line-height: 1.8 !important;
  }
</style>

<div class="comment-toggle">
  <button id="btn-twikoo" type="button">Twikoo ğŸ’¬</button>
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

<div id="twikoo-container" class="comment-system">
  <div id="twikoo"></div>
</div>

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

<style>
  .comment-toggle { margin-bottom: 1em; text-align: center; }
  .comment-toggle button {
    padding: 0.5em 1.2em; margin: 0 0.3em; cursor: pointer;
    border: 1px solid #ccc; background: #f8f8f8; color: #555;
    font-weight: 500; border-radius: 4px; font-size: 0.9rem;
    transition: background 0.2s, color 0.2s, border-color 0.2s;
  }
  .comment-toggle button:hover { background: #e2e2e2; border-color: #999; color: #333; }
  .comment-toggle button.active {
    background: #ccc; border-color: #999; color: #222;
    cursor: default; pointer-events: none;
  }

  .comment-system { display: none; }
  .comment-system.active { display: block; }

  /* ä½ åŸæ¥çš„å­—ä½“æ ·å¼ï¼ˆå¯ç•™å¯åˆ ï¼‰ */
  html[lang="en-US"] .comment-system, html[lang="en-US"] .comment-system * {
    font-family: "Georgia", "Times New Roman", serif !important;
    font-size: 1rem !important;
    font-weight: 400 !important;
    line-height: 1.6 !important;
  }
  html[lang="zh-CN"] .comment-system, html[lang="zh-CN"] .comment-system * {
    font-family: 'KingHwa_OldSong', sans-serif !important;
    font-size: 1rem !important;
    font-weight: 400 !important;
    line-height: 1.8 !important;
  }
</style>

<div class="comment-toggle">
  <button id="btn-twikoo" type="button">Twikoo ğŸ’¬</button>
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

<div id="twikoo-container" class="comment-system">
  <div id="twikoo"></div>
</div>

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

{{- /* ===== Twikoo pathï¼šA/B ç»„åˆ ===== */ -}}
{{- $twPath := .RelPermalink -}}
{{- with .Params.translationKey -}}
  {{- $twPath = printf "/t/%s/" (. | urlize) -}}
{{- else -}}
  {{- $twPath = $twPath | replaceRE "^/(en|zh|ja)/" "/" -}}
{{- end -}}

{{- /* ===== Twikoo lang æ˜ å°„ï¼ˆen-US/zh ç­‰éƒ½ç¨³ï¼‰===== */ -}}
{{- $twLangRaw := .Site.Language.Lang -}}
{{- $twLang := "en" -}}
{{- if hasPrefix (lower $twLangRaw) "zh" -}}
  {{- $twLang = "zh-CN" -}}
{{- else if hasPrefix (lower $twLangRaw) "en" -}}
  {{- $twLang = "en" -}}
{{- end -}}

{{- /* ===== Giscus lang ===== */ -}}
{{- $giscusLang := "en" -}}
{{- if hasPrefix (lower .Site.Language.Lang) "zh" -}}
  {{- $giscusLang = "zh-CN" -}}
{{- end -}}

<script>
  const btnTwikoo = document.getElementById('btn-twikoo');
  const btnGiscus = document.getElementById('btn-giscus');
  const twikooContainer = document.getElementById('twikoo-container');
  const giscusContainer = document.getElementById('giscus-container');

  let twikooInited = false;
  let giscusLoaded = false;

  function setActive(which) {
    const isTw = which === 'twikoo';
    btnTwikoo.classList.toggle('active', isTw);
    btnGiscus.classList.toggle('active', !isTw);
    twikooContainer.classList.toggle('active', isTw);
    giscusContainer.classList.toggle('active', !isTw);
    localStorage.setItem('preferredComment', which);
  }

  function loadScript(urls) {
    return new Promise((resolve, reject) => {
      let i = 0;
      const tryNext = () => {
        if (i >= urls.length) return reject(new Error("All CDN failed: " + urls.join(", ")));
        const s = document.createElement('script');
        s.src = urls[i++];
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => tryNext();
        document.head.appendChild(s);
      };
      tryNext();
    });
  }

  async function initTwikooOnceVisible() {
    if (twikooInited) return;

    // å…³é”®ï¼šinit å‰å¿…é¡»â€œå¯å¸ƒå±€â€ï¼Œä¸èƒ½ display:none
    twikooContainer.classList.add('active');
    const oldVis = twikooContainer.style.visibility;
    twikooContainer.style.visibility = 'hidden'; // ä¸é—ªç°ï¼Œä½†ä»æœ‰å¸ƒå±€å°ºå¯¸

    await loadScript([
      "https://cdn.jsdelivr.net/npm/twikoo@1.6.40/dist/twikoo.all.min.js",
      "https://unpkg.com/twikoo@1.6.40/dist/twikoo.all.min.js"
    ]);

    if (!window.twikoo) throw new Error("twikoo not found on window after loading script");

    window.twikoo.init({
      envId: {{ .Site.Params.twikoo.id | jsonify }},
      el: "#twikoo",
      region: {{ .Site.Params.twikoo.region | jsonify }},
      lang: {{ $twLang | jsonify }},
      path: {{ $twPath | jsonify }}
    });

    twikooInited = true;

    // æ¢å¤å¯è§æ€§ï¼ˆåé¢ç”± showTwikoo/showGiscus æ§åˆ¶æ˜¾ç¤ºï¼‰
    twikooContainer.style.visibility = oldVis || '';
  }

  async function loadGiscusOnce() {
    if (giscusLoaded) return;
    const s = document.createElement('script');
    s.src = "https://giscus.app/client.js";
    s.setAttribute("data-repo", "Liuqiran/liuqiran.github.io");
    s.setAttribute("data-repo-id", "R_kgDONiVddQ");
    s.setAttribute("data-category", "General");
    s.setAttribute("data-category-id", "DIC_kwDONiVddc4CljSp");
    s.setAttribute("data-mapping", "title");
    s.setAttribute("data-strict", "0");
    s.setAttribute("data-reactions-enabled", "1");
    s.setAttribute("data-emit-metadata", "0");
    s.setAttribute("data-input-position", "bottom");
    s.setAttribute("data-theme", "preferred_color_scheme");
    s.setAttribute("data-lang", {{ $giscusLang | jsonify }});
    s.crossOrigin = "anonymous";
    s.async = true;
    document.getElementById("giscus-comment").appendChild(s);
    giscusLoaded = true;
  }

  async function showTwikoo() {
    setActive('twikoo');
    try { await initTwikooOnceVisible(); } catch (e) { console.error(e); }
  }

  async function showGiscus() {
    setActive('giscus');
    try { await loadGiscusOnce(); } catch (e) { console.error(e); }
  }

  btnTwikoo.addEventListener('click', showTwikoo);
  btnGiscus.addEventListener('click', showGiscus);

  (async function boot() {
    // ä¸ºäº†è®©é˜…è¯»é‡ #twikoo_visitors èƒ½æ›´æ–°ï¼šå…ˆ init ä¸€æ¬¡ twikooï¼ˆä¸é—ªç°ï¼‰
    try { await initTwikooOnceVisible(); } catch (e) { console.error(e); }

    const preferred = localStorage.getItem('preferredComment');
    if (preferred === 'giscus') await showGiscus();
    else await showTwikoo();
  })();
</script>
