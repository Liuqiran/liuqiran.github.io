{{/* layouts/partials/comments.html */}}

{{- $langRaw := .Lang | lower -}}

{{/* ===== serverURLï¼ˆæ¨¡æ¿ä¾§æ¸…æ´—ï¼‰===== */}}
{{- $server := "" -}}
{{- with site.Params.waline.serverURL -}}
  {{- $server = . -}}
{{- end -}}
{{- $server = $server | replaceRE `\\` "" -}}
{{- $server = $server | replaceRE `["']` "" -}}
{{- $server = $server | replaceRE `^\s+|\s+$` "" -}}
{{- $server = $server | replaceRE `/+$` "" -}}
{{- $hasWaline := ne $server "" -}}

{{/* ===== walineLang å…œåº•ï¼ˆçœŸæ­£ä»¥ <html lang> ä¸ºå‡†ï¼‰===== */}}
{{- $walineLang := "en" -}}
{{- if hasPrefix $langRaw "zh" -}}
  {{- $walineLang = "zh-CN" -}}
{{- else if or (hasPrefix $langRaw "ja") (hasPrefix $langRaw "jp") -}}
  {{- $walineLang = "jp" -}}
{{- end -}}

{{/* ===== commentPathï¼št:translationKeyï¼ˆæ— åˆ™æ–‡ä»¶åï¼‰===== */}}
{{- $tkey := "" -}}
{{- with .Params.translationKey -}}
  {{- $tkey = . -}}
{{- else -}}
  {{- with .File -}}{{- $tkey = .BaseFileName -}}{{- end -}}
{{- end -}}
{{- $tkey = $tkey | replaceRE `\\` "" -}}
{{- $tkey = $tkey | replaceRE `["']` "" -}}
{{- $tkey = $tkey | replaceRE `^\s+|\s+$` "" -}}
{{- $commentPath := printf "t:%s" $tkey -}}

<style>
/* ===== Toggle ===== */
.comment-toggle{ margin:1em 0; text-align:center; }
.comment-toggle button{
  padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
  border:1px solid var(--border, #ccc);
  background: var(--entry, #f8f8f8);
  color: var(--content, #555);
  font-weight:500; border-radius:8px; font-size:.9rem;
}
.comment-toggle button.active{
  background: var(--code-bg, #ddd);
  border-color: var(--border, #999);
  color: var(--content, #222);
  cursor:default; pointer-events:none;
}
.comment-system{ display:none; }
.comment-system.active{ display:block; }

/* ===== Waline theme ===== */
#waline{
  --waline-theme-color: var(--primary);
  --waline-active-color: var(--primary);
  --waline-color: var(--content);
  --waline-bg-color: var(--entry);
  --waline-bg-color-light: var(--code-bg);
  --waline-border-color: var(--border);
  --waline-box-shadow: none;
}

/* å¯é€‰ï¼šåªè®©ä¸­æ–‡è¯„è®ºåŒºç”¨â€œè€å®‹â€ï¼ˆæŠŠ font-family æ¢æˆä½ çš„å®é™…å­—ä½“åï¼‰ */
/*
html[lang^="zh"] #waline,
html[lang^="zh"] #waline *{
  font-family: 'KingHwa_OldSong', serif !important;
}
*/

/* ===== FABï¼ˆTOC + Commentsï¼›ç§»åŠ¨ç«¯æŠŠ Top æ”¶è¿›åŒä¸€åˆ—ï¼‰ ===== */
.kq-fab{
  --kq-fab-bottom: 16px;
  --kq-fab-gap: 12px;

  position: fixed;
  right: calc(16px + env(safe-area-inset-right));
  bottom: calc(var(--kq-fab-bottom) + env(safe-area-inset-bottom));

  display: none;
  flex-direction: column;
  gap: var(--kq-fab-gap);
  z-index: 9999;
}
.kq-fab.is-on{ display:flex; }

/* æ¡Œé¢ç«¯ï¼štop-link é¡¶åˆ° FAB ä¸Šæ–¹ */
html.kq-fab-on a.top-link{
  right: calc(16px + env(safe-area-inset-right)) !important;
  bottom: calc(
    var(--kq-fab-bottom, 16px)
    + env(safe-area-inset-bottom)
    + var(--kq-fab-h, 0px)
    + var(--kq-fab-gap, 12px)
  ) !important;
}

/* æ‰‹æœºï¼šåªæ”¹å˜é‡ï¼Œä¸å†™æ­» bottom */
@media (max-width: 900px){
}

.kq-fab-btn{
  width: 44px; height: 44px;
  border-radius: 999px;
  border: 1px solid var(--border, #ccc);
  background: var(--entry, #fff);
  color: var(--content, #222);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  box-shadow: 0px 2px 4px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
}
.kq-fab-btn:hover{
  box-shadow: 0px 4px 8px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
}

/* âœ… åªå½±å“â€œè¢«å¡è¿› FAB çš„ top-linkâ€ï¼Œä¸åŠ¨ä½ åŸ Top.css */
.kq-fab a.top-link.kq-top-in-fab{
  position: static !important;
  right: auto !important;
  bottom: auto !important;

  width: 44px !important;
  height: 44px !important;
  padding: 0 !important;
  margin: 0 !important;

  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  border-radius: 999px !important;
}

/* ä¿æŒç®­å¤´ä¸Šã€æ•°å­—ä¸‹ï¼ˆgrid ç«–æ’ï¼‰ï¼Œå¹¶å»æ‰ topInner çš„ margin:7px */
.kq-fab a.top-link.kq-top-in-fab .topInner{
  margin: 0 !important;
  display: grid !important;
  justify-items: center !important;
  align-content: center !important;
  gap: 2px !important;
}

/* âœ… ç²¾å‡†åªå‘½ä¸­ç™¾åˆ†æ¯”æ•°å­—ï¼š#read_progressï¼ˆé¿å…å½±å“ svg / å…¶ä»– spanï¼‰ */
@media (max-width: 900px){
  .kq-fab a.top-link.kq-top-in-fab #read_progress{
    font-size: 11px !important;      /* åŸæ¥ 10px â†’ 11px */
    line-height: 1 !important;
    letter-spacing: -0.08em !important; /* ç¨å¾®æ›´æŒ¤ä¸€ç‚¹ï¼Œä¿è¯ 100 ä»å¡å¾—ä¸‹ */
    font-variant-numeric: tabular-nums;
    white-space: nowrap !important;
    overflow-wrap: normal !important;
    word-break: keep-all !important;
  }
}

.kq-fab a.top-link.kq-top-in-fab svg{
  width: 20px !important;
  height: 20px !important;
}
/* overlayï¼ˆé»˜è®¤ä¸æŒ¡ç‚¹å‡»ï¼‰ */
.kq-toc-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  opacity: 0; pointer-events: none;
  transition: opacity .18s ease;
  z-index: 9998;
}
html.kq-toc-open .kq-toc-overlay{
  opacity: 1; pointer-events: auto;
}

/* iPhone å®‰å…¨åŒº + æ‰‹æœº TOC æŠ½å±‰ */
@media (max-width: 900px){

  html.kq-toc-open #toc-container{ right: 0; }

  #toc-container .inner{
    max-height: calc(100vh - 56px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  #toc-container summary{ display:none; }
  #toc-container details{ height:100%; }
}

/* âœ… åªä¿® FAB é‡Œçš„ Topï¼š100 ä¸æ¢è¡Œï¼ˆä¸æ”¹ä½ çš„ Top.css æ–‡ä»¶ï¼‰ */
@media (max-width: 900px){
  /* 1) FAB é‡Œå–æ¶ˆ topInner çš„ 7px marginï¼Œä¸ç„¶ 44px åœ†é‡Œå‰©ä½™å®½åº¦å¤ªå° */
  .kq-fab a.top-link.kq-top-in-fab .topInner{
    margin: 0 !important;
  }

  /* 2) ç¦æ­¢ç™¾åˆ†æ¯”æ–­è¡Œï¼ˆè¦†ç›–å¯èƒ½å­˜åœ¨çš„ break-all/anywhereï¼‰ */
  .kq-fab a.top-link.kq-top-in-fab,
  .kq-fab a.top-link.kq-top-in-fab .topInner{
    white-space: nowrap !important;
    overflow-wrap: normal !important;
    word-break: keep-all !important;
  }

  /* 3) ç»™â€œç™¾åˆ†æ¯”æ–‡æœ¬â€è‡³å°‘ 3ch å®½åº¦ï¼ˆæ›´ç¨³ï¼‰â€”â€”å¤šç§ id/class å…œåº• */
  .kq-fab a.top-link.kq-top-in-fab #top-percent,
  .kq-fab a.top-link.kq-top-in-fab #topPercent,
  .kq-fab a.top-link.kq-top-in-fab .top-percent,
  .kq-fab a.top-link.kq-top-in-fab .topPercent,
  .kq-fab a.top-link.kq-top-in-fab .topInner span{
    text-align: right;
    white-space: nowrap !important;
    overflow-wrap: normal !important;
    word-break: keep-all !important;
    line-height: 1;
  }
}  
/* âœ… åªä¿® FAB é‡Œçš„ Top ç™¾åˆ†æ¯”ï¼šä¸æ‹†è¡Œï¼Œä¸å˜å®½ï¼Œä¸å½±å“åŸæ ·å¼ */
@media (max-width: 900px){
  /* å…³é”®ï¼šFAB é‡ŒæŠŠ topInner çš„ 7px margin å»æ‰ï¼Œå¦åˆ™ 44px åœ†é‡Œå¤ªæŒ¤ä¼šæŠŠ 100 æ‹†æˆ 10+0 */
  .kq-fab a.top-link.kq-top-in-fab .topInner{
    margin: 0 !important;           /* è¦†ç›–ä½  Top.css çš„ margin:7px */
    display: grid !important;       /* ä¿æŒç®­å¤´ä¸Šã€æ•°å­—ä¸‹ */
    justify-items: center !important;
    align-content: center !important;
    gap: 2px !important;
  }

  /* åªé’ˆå¯¹æ•°å­—ï¼Œä¸åŠ¨ svg */
  .kq-fab a.top-link.kq-top-in-fab #read_progress{
    white-space: nowrap !important;
    overflow-wrap: normal !important;
    word-break: keep-all !important;

    font-size: 10px !important;     /* è®© 100 ä¹Ÿå¡å¾—ä¸‹ */
    line-height: 1 !important;
    letter-spacing: -0.06em !important;
    font-variant-numeric: tabular-nums;
  }
}

</style>

<div class="comment-toggle">
  {{- if $hasWaline -}}<button id="btn-waline" type="button">Waline ğŸ’¬</button>{{- end -}}
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

{{- if $hasWaline -}}
<div id="waline-container" class="comment-system">
  <div id="waline"></div>
</div>
{{- end -}}

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

<div class="kq-toc-overlay" id="kq-toc-overlay" aria-hidden="true"></div>

<div class="kq-fab" id="kq-fab">
  <button class="kq-fab-btn" id="kq-fab-toc" type="button" aria-label="TOC">â˜°</button>
  <button class="kq-fab-btn" id="kq-fab-cmt" type="button" aria-label="Comments">ğŸ’¬</button>
</div>

<script>
(() => {
  // ====== ä» Hugo ä¼ å€¼è¿›æ¥ ======
  const HAS_WALINE = {{ $hasWaline | jsonify }};
  const HUGO_SERVER_RAW = {{ $server | jsonify }};
  const HUGO_PATH_RAW = {{ $commentPath | jsonify }};
  const HUGO_LANG_FALLBACK = {{ $walineLang | jsonify }};

  // ====== DOM ======
  const btnWaline = document.getElementById('btn-waline');
  const btnGiscus = document.getElementById('btn-giscus');
  const walineContainer = document.getElementById('waline-container');
  const giscusContainer = document.getElementById('giscus-container');

  const fab = document.getElementById('kq-fab');
  const btnTOC = document.getElementById('kq-fab-toc');
  const btnCmt = document.getElementById('kq-fab-cmt');
  const overlay = document.getElementById('kq-toc-overlay');
  const toc = document.getElementById('toc-container');
  const mqMobile = window.matchMedia('(max-width: 900px)');

  // ====== helpers ======
  function cleanString(x){
    return String(x ?? "").replace(/\\/g, "").replace(/["']/g, "").trim();
  }
  function cleanServerURL(x){
    let s = cleanString(x).replace(/\/+$/, "");
    s = s.replace(/^(https?:\/\/)(https?:\/\/)+/i, "$1");
    const ms = s.match(/https?:\/\//ig);
    if (ms && ms.length > 1) s = s.slice(s.toLowerCase().lastIndexOf("http"));
    if (s.startsWith("//")) s = "https:" + s;
    return s.replace(/\/+$/, "");
  }
  function isValidHttpUrl(s){
    try{
      const u = new URL(s);
      return u.protocol === "http:" || u.protocol === "https:";
    }catch(e){ return false; }
  }
  function deferLoad(fn) {
    if ('requestIdleCallback' in window) requestIdleCallback(fn, { timeout: 1200 });
    else setTimeout(fn, 250);
  }

  // ====== Lang normalize ======
  function normalizeWalineLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "jp";
    return "en";
  }
  function normalizeGiscusLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "ja";
    return "en";
  }

// ====== Waline (çœŸæ­£æ‡’åŠ è½½ï¼šCSS + JS éƒ½åªåœ¨éœ€è¦æ—¶åŠ è½½) ======
let walineReady = false;
let walineLoading = null;

const serverURL = cleanServerURL(HUGO_SERVER_RAW);
const commentPath = cleanString(HUGO_PATH_RAW);

// å»ºè®®ï¼šWaline æ›´æ ‡å‡†çš„è¯­è¨€ç ç”¨ en-US / zh-CN / jpï¼ˆä¸è¡Œä¹Ÿä¼šè‡ªåŠ¨ fallbackï¼‰:contentReference[oaicite:1]{index=1}
const pageLangWaline = normalizeWalineLang(document.documentElement.lang || HUGO_LANG_FALLBACK || "en");

const walineOK = HAS_WALINE && walineContainer && isValidHttpUrl(serverURL);
if (!walineOK) window.__walineBadConfig = true;

// === ä½ çš„â€œè¾“å…¥æ¡†è‡ªå®šä¹‰æ–‡å­—â€ï¼ˆæŒ‰è¯­è¨€ï¼‰===
// ä½ æƒ³å†™å¤šè¡Œå°±ç”¨ \n
const PLACEHOLDER_MAP = {
  "zh-CN": "è°¢è°¢ä½ æ¥åˆ°è¿™é‡Œâ€”â€”æˆ‘éƒ½ä¼šçœ‹ã€‚",
  "jp": "ã‚³ãƒ¡ãƒ³ãƒˆã©ã†ãâ€¦(*^_^*)",
  "en-US": "Thanks for being hereâ€”this wasnâ€™t written into the void.\nI read every note. ",
  "en": "Thanks for being hereâ€”this wasnâ€™t written into the void.\nI read every note. ",
};
const myPlaceholder = PLACEHOLDER_MAP[pageLangWaline] || "Write a commentâ€¦";

function loadWalineCSSOnce() {
  if (document.getElementById('kq-waline-css')) return;

  const link = document.createElement('link');
  link.id = 'kq-waline-css';
  link.rel = 'stylesheet';
  link.href = 'https://unpkg.com/@waline/client@v3/dist/waline.css';
  document.head.appendChild(link);

  // å¯é€‰ï¼šé˜²æ­¢ä¸»é¢˜æŠŠ placeholder é€æ˜åº¦å‹æ²¡ï¼ˆä½ å¦‚æœæœ¬æ¥å°±æ­£å¸¸å¯åˆ ï¼‰
  if (!document.getElementById('kq-waline-ph-style')) {
    const st = document.createElement('style');
    st.id = 'kq-waline-ph-style';
    st.textContent = `
      #waline textarea::placeholder,
      #waline input::placeholder { opacity: .85; }
    `;
    document.head.appendChild(st);
  }
}

function ensureWaline() {
  if (!walineOK || walineReady) return;
  if (walineLoading) return;

  walineLoading = (async () => {
    loadWalineCSSOnce();
    const mod = await import('https://unpkg.com/@waline/client@v3/dist/waline.js');

    mod.init({
      el: "#waline",
      serverURL,
      path: commentPath,
      requiredMeta: ["nick", "mail"],
      lang: pageLangWaline,

      // âœ… è¾“å…¥æ¡†æç¤ºæ–‡å­—å°±åœ¨è¿™é‡Œï¼šlocale.placeholder :contentReference[oaicite:2]{index=2}
      // reactionTitle ä½ è®¾ä¸ºç©ºä¼šæŠŠâ€œååº”/è¡¨æƒ…â€æ ‡é¢˜éšè— :contentReference[oaicite:3]{index=3}
      locale: {
        placeholder: myPlaceholder,
        reactionTitle: "",
      },

      reaction: true,
      dark: "body.dark",
      imageUploader: false,
    });

    walineReady = true;
    walineLoading = null;
    console.log("[Waline] inited:", { serverURL, commentPath, pageLangWaline });
  })().catch((e) => {
    console.error("[Waline] init failed:", e);
    window.__walineBadConfig = true;
    walineLoading = null;
    showGiscus(true);
  });
}

  // ====== Giscus æ‡’åŠ è½½ ======
  const GISCUS_REPO = "Liuqiran/liuqiran.github.io";
  const GISCUS_REPO_ID = "R_kgDONiVddQ";
  const GISCUS_CATEGORY = "General";
  const GISCUS_CATEGORY_ID = "DIC_kwDONiVddc4CljSp";
  const giscusTerm = cleanString(HUGO_PATH_RAW);

  let giscusLoaded = false;
  function ensureGiscus() {
    if (giscusLoaded) return;
    giscusLoaded = true;

    const lang = normalizeGiscusLang(document.documentElement.lang);
    const host = document.getElementById('giscus-comment');
    if (!host) return;
    host.innerHTML = "";

    const s = document.createElement('script');
    s.src = 'https://giscus.app/client.js';
    s.async = true;
    s.crossOrigin = 'anonymous';

    s.setAttribute('data-repo', GISCUS_REPO);
    s.setAttribute('data-repo-id', GISCUS_REPO_ID);
    s.setAttribute('data-category', GISCUS_CATEGORY);
    s.setAttribute('data-category-id', GISCUS_CATEGORY_ID);
    s.setAttribute('data-mapping', 'specific');
    s.setAttribute('data-term', giscusTerm);
    s.setAttribute('data-strict', '0');
    s.setAttribute('data-reactions-enabled', '1');
    s.setAttribute('data-emit-metadata', '0');
    s.setAttribute('data-input-position', 'bottom');
    s.setAttribute('data-theme', 'preferred_color_scheme');
    s.setAttribute('data-lang', lang);

    host.appendChild(s);
    console.log("[Giscus] loaded:", { giscusTerm, lang });
  }

  // ====== UI åˆ‡æ¢ ======
  function showWaline(loadNow=true) {
    if (!walineOK) return showGiscus(loadNow);

    if (btnWaline) btnWaline.classList.add('active');
    if (btnGiscus) btnGiscus.classList.remove('active');

    if (walineContainer) walineContainer.classList.add('active');
    if (giscusContainer) giscusContainer.classList.remove('active');

    localStorage.setItem('preferredComment', 'waline');
    if (loadNow) ensureWaline();
  }

  function showGiscus(loadNow=true) {
    if (btnGiscus) btnGiscus.classList.add('active');
    if (btnWaline) btnWaline.classList.remove('active');

    if (giscusContainer) giscusContainer.classList.add('active');
    if (walineContainer) walineContainer.classList.remove('active');

    localStorage.setItem('preferredComment', 'giscus');
    if (loadNow) ensureGiscus();
  }

  // æš´éœ²ç»™ FAB
  window.__kqShowWaline = () => showWaline(true);
  window.__kqShowGiscus = () => showGiscus(true);

  if (btnWaline) btnWaline.onclick = () => showWaline(true);
  if (btnGiscus) btnGiscus.onclick = () => showGiscus(true);

  // é¦–å±ï¼šå…ˆåˆ‡ UIï¼Œä¸ç«‹åˆ»åŠ è½½ï¼›ç©ºé—²å†åŠ è½½
  window.addEventListener('DOMContentLoaded', () => {
    const preferred = localStorage.getItem('preferredComment');

    if (!walineOK) {
      showGiscus(false);
      deferLoad(() => ensureGiscus());
    } else if (preferred === 'giscus') {
      showGiscus(false);
      deferLoad(() => ensureGiscus());
    } else {
      showWaline(false);
      deferLoad(() => ensureWaline());
    }
  });

  // ====== FABï¼šTOC / Comments ======
  function closeTOC(){ document.documentElement.classList.remove('kq-toc-open'); }
  function openTOC(){
    if (!toc) return;
    const d = toc.querySelector('details');
    if (d) d.open = true;

    if (mqMobile.matches) {
      document.documentElement.classList.add('kq-toc-open');
    } else {
      toc.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  btnTOC && btnTOC.addEventListener('click', openTOC);
  overlay && overlay.addEventListener('click', closeTOC);

  toc && toc.addEventListener('click', (e) => {
    const a = e.target.closest('a[href^="#"]');
    if (a && mqMobile.matches) closeTOC();
  });

  btnCmt && btnCmt.addEventListener('click', () => {
    closeTOC();

const preferred = localStorage.getItem('preferredComment');
const canWaline = walineContainer && walineOK;
const canGiscus = !!giscusContainer;

if (preferred === 'giscus' && canGiscus) showGiscus(true);
else if (canWaline) showWaline(true);
else if (canGiscus) showGiscus(true);


    const active = document.querySelector('.comment-system.active');
    const target =
      (active && (active.querySelector('#waline') || active.querySelector('#giscus-comment'))) ||
      document.getElementById('waline') ||
      document.getElementById('giscus-comment');

    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

window.addEventListener('DOMContentLoaded', () => {
  if (!fab) return;

  // 1) æ²¡ TOC åˆ  â˜°
  if (!toc && btnTOC) btnTOC.remove();

  // 2) æ²¡è¯„è®ºç³»ç»Ÿåˆ  ğŸ’¬
  const hasAnyComment = (walineContainer && walineOK) || !!giscusContainer;
  if (!hasAnyComment && btnCmt) btnCmt.remove();

  // 3) æ˜¯å¦è¿˜æœ‰æ§ä»¶
  const hasAnyControl = !!fab.querySelector('button, a');

  const html = document.documentElement;

  function syncFabOffset(){
    const h = fab ? fab.getBoundingClientRect().height : 0;
    html.style.setProperty('--kq-fab-h', h ? `${Math.ceil(h)}px` : '0px');
  }

  if (hasAnyControl) {
    fab.classList.add('is-on');
    html.classList.add('kq-fab-on');

 // âœ… ç§»åŠ¨ç«¯ï¼šæŠŠä¸»é¢˜çš„â€œè¿”å›é¡¶éƒ¨â€æŒ‰é’®å¡è¿› FABï¼Œä¸‰æŒ‰é’®åŒæ ˆç«–æ’
    const topLink = document.querySelector('a.top-link');
    let topLinkHome = null;
    let topLinkNext = null;

    function syncTopLinkPlacement(){
      if (!topLink) return;

      if (mqMobile.matches) {
        // åªåœ¨æ‰‹æœºå¡è¿›å»
        if (!fab.contains(topLink)) {
          topLinkHome = topLinkHome || topLink.parentElement;
          topLinkNext = topLinkNext || topLink.nextSibling;

          topLink.classList.add('kq-top-in-fab');
          fab.appendChild(topLink);
        }
      } else {
        // æ¡Œé¢ï¼šæ”¾å›åŸä½ç½®ï¼ˆå¯é€‰ï¼Œä½†å»ºè®®ä¿ç•™ï¼‰
        if (topLinkHome && topLink.classList.contains('kq-top-in-fab')) {
          topLink.classList.remove('kq-top-in-fab');
          topLinkHome.insertBefore(topLink, topLinkNext);
        }
      }

      requestAnimationFrame(syncFabOffset);
    }

    syncTopLinkPlacement();
    mqMobile.addEventListener('change', syncTopLinkPlacement);

    // ç­‰ä¸€å¸§è®© display:flex ç”Ÿæ•ˆå†æµ‹é«˜åº¦
    requestAnimationFrame(syncFabOffset);

    window.addEventListener('resize', () => {
      if (html.classList.contains('kq-fab-on')) requestAnimationFrame(syncFabOffset);
    }, { passive: true });
  } else {
    fab.classList.remove('is-on');
    html.classList.remove('kq-fab-on');
    syncFabOffset();
  }
});
})();
</script>
