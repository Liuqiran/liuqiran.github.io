{{/* layouts/partials/comments.html */}}

{{- $lang := .Lang -}}

{{/* ===== serverURLÔºàÂº∫ÂäõÊ∏ÖÊ¥óÔºâ===== */}}
{{- $server := "" -}}
{{- with site.Params.waline.serverURL -}}
  {{- $server = . -}}
{{- end -}}
{{- $server = $server | replaceRE `\\` "" -}}
{{- $server = $server | replaceRE `["']` "" -}}
{{- $server = $server | replaceRE `^\s+|\s+$` "" -}}
{{- $server = $server | replaceRE `/+$` "" -}}
{{- $hasWaline := ne $server "" -}}

{{/* ===== ËØ≠Ë®ÄÊò†Â∞ÑÔºàÂè™ÂÆö‰πâ‰∏ÄÊ¨°Ôºâ===== */}}
{{- $walineLang := "en" -}}
{{- $giscusLang := "en" -}}
{{- if eq $lang "zh" -}}
  {{- $walineLang = "zh-CN" -}}
  {{- $giscusLang = "zh-CN" -}}
{{- else if eq $lang "ja" -}}
  {{- $walineLang = "ja" -}}
  {{- $giscusLang = "ja" -}}
{{- end -}}

{{/* ===== commentPathÔºöÊ∞∏Ëøú t:translationKeyÔºàÊ≤°ÊúâÂ∞±Áî®Êñá‰ª∂ÂêçÔºâ===== */}}
{{- $tkey := "" -}}
{{- with .Params.translationKey -}}
  {{- $tkey = . -}}
{{- else -}}
  {{- with .File -}}{{- $tkey = .BaseFileName -}}{{- end -}}
{{- end -}}

{{- $tkey = $tkey | replaceRE `\\` "" -}}
{{- $tkey = $tkey | replaceRE `["']` "" -}}
{{- $tkey = $tkey | replaceRE `^\s+|\s+$` "" -}}

{{- $commentPath := printf "t:%s" $tkey -}}

<style>
.comment-toggle{ margin:1em 0; text-align:center; }
.comment-toggle button{
  padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
  border:1px solid var(--border, #ccc);
  background: var(--entry, #f8f8f8);
  color: var(--content, #555);
  font-weight:500; border-radius:8px; font-size:.9rem;
}
.comment-toggle button.active{
  background: var(--code-bg, #ddd);
  border-color: var(--border, #999);
  color: var(--content, #222);
  cursor:default; pointer-events:none;
}
.comment-system{ display:none; }
.comment-system.active{ display:block; }

#waline{
  --waline-theme-color: var(--primary);
  --waline-active-color: var(--primary);
  --waline-color: var(--content);
  --waline-bg-color: var(--entry);
  --waline-bg-color-light: var(--code-bg);
  --waline-border-color: var(--border);
  --waline-box-shadow: none;
}
</style>

<div class="comment-toggle">
  {{- if $hasWaline -}}<button id="btn-waline">Waline üí¨</button>{{- end -}}
  <button id="btn-giscus">Giscus üí¨</button>
</div>

{{- if $hasWaline -}}
<div id="waline-container" class="comment-system">
  <div id="waline"></div>
  <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />

  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

    let serverURL = {{ $server | jsonify }};
    serverURL = String(serverURL || "")
      .replace(/\\/g, "")
      .replace(/["']/g, "")
      .trim()
      .replace(/\/+$/, "");

    let commentPath = {{ $commentPath | jsonify }};
    commentPath = String(commentPath || "")
      .replace(/\\/g, "")
      .replace(/["']/g, "")
      .trim();

    console.log("Waline serverURL =", serverURL);
    console.log("Waline path =", commentPath);

    init({
      el: '#waline',
      serverURL,
      path: commentPath,
      requiredMeta: ['nick', 'mail'],
      lang: {{ $walineLang | jsonify }},
      locale: { reactionTitle: "" },
      reaction: true,
      dark: 'body.dark',
    });
  </script>
</div>
{{- end -}}

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
  <script src="https://giscus.app/client.js"
          data-repo="Liuqiran/liuqiran.github.io"
          data-repo-id="R_kgDONiVddQ"
          data-category="General"
          data-category-id="DIC_kwDONiVddc4CljSp"
          data-mapping="specific"
          data-term="{{ $commentPath }}"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="preferred_color_scheme"
          data-lang="{{ $giscusLang }}"
          crossorigin="anonymous"
          async>
  </script>
</div>

<script>
  const btnWaline = document.getElementById('btn-waline');
  const btnGiscus = document.getElementById('btn-giscus');
  const walineContainer = document.getElementById('waline-container');
  const giscusContainer = document.getElementById('giscus-container');

  function showWaline() {
    if (!btnWaline || !walineContainer) return;
    btnWaline.classList.add('active');
    btnGiscus.classList.remove('active');
    walineContainer.classList.add('active');
    giscusContainer.classList.remove('active');
    localStorage.setItem('preferredComment', 'waline');
  }

  function showGiscus() {
    btnGiscus.classList.add('active');
    if (btnWaline) btnWaline.classList.remove('active');
    giscusContainer.classList.add('active');
    if (walineContainer) walineContainer.classList.remove('active');
    localStorage.setItem('preferredComment', 'giscus');
  }

  if (btnWaline) btnWaline.onclick = showWaline;
  btnGiscus.onclick = showGiscus;

  window.addEventListener('DOMContentLoaded', () => {
    const preferred = localStorage.getItem('preferredComment');
    if (preferred === 'giscus') return showGiscus();
    if (btnWaline) return showWaline();
    showGiscus();
  });
</script>
