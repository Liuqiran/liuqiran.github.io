{{/* layouts/partials/comments.html */}}

{{- $langRaw := .Lang | lower -}}

{{/* ===== serverURLï¼ˆæ¨¡æ¿ä¾§æ¸…æ´—ï¼‰===== */}}
{{- $server := "" -}}
{{- with site.Params.waline.serverURL -}}
  {{- $server = . -}}
{{- end -}}
{{- $server = $server | replaceRE `\\` "" -}}
{{- $server = $server | replaceRE `["']` "" -}}
{{- $server = $server | replaceRE `^\s+|\s+$` "" -}}
{{- $server = $server | replaceRE `/+$` "" -}}
{{- $hasWaline := ne $server "" -}}

{{/* ===== walineLang å…œåº•ï¼ˆçœŸæ­£ä»¥ <html lang> ä¸ºå‡†ï¼‰===== */}}
{{- $walineLang := "en" -}}
{{- if hasPrefix $langRaw "zh" -}}
  {{- $walineLang = "zh-CN" -}}
{{- else if or (hasPrefix $langRaw "ja") (hasPrefix $langRaw "jp") -}}
  {{- $walineLang = "jp" -}}
{{- end -}}

{{/* ===== commentPathï¼št:translationKeyï¼ˆæ— åˆ™æ–‡ä»¶åï¼‰===== */}}
{{- $tkey := "" -}}
{{- with .Params.translationKey -}}
  {{- $tkey = . -}}
{{- else -}}
  {{- with .File -}}{{- $tkey = .BaseFileName -}}{{- end -}}
{{- end -}}
{{- $tkey = $tkey | replaceRE `\\` "" -}}
{{- $tkey = $tkey | replaceRE `["']` "" -}}
{{- $tkey = $tkey | replaceRE `^\s+|\s+$` "" -}}
{{- $commentPath := printf "t:%s" $tkey -}}

<style>
/* ===== Toggle ===== */
.comment-toggle{ margin:1em 0; text-align:center; }
.comment-toggle button{
  padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
  border:1px solid var(--border, #ccc);
  background: var(--entry, #f8f8f8);
  color: var(--content, #555);
  font-weight:500; border-radius:8px; font-size:.9rem;
}
.comment-toggle button.active{
  background: var(--code-bg, #ddd);
  border-color: var(--border, #999);
  color: var(--content, #222);
  cursor:default; pointer-events:none;
}
.comment-system{ display:none; }
.comment-system.active{ display:block; }

/* ===== Waline theme ===== */
#waline{
  --waline-theme-color: var(--primary);
  --waline-active-color: var(--primary);
  --waline-color: var(--content);
  --waline-bg-color: var(--entry);
  --waline-bg-color-light: var(--code-bg);
  --waline-border-color: var(--border);
  --waline-box-shadow: none;
}

/* ï¼ˆå¯é€‰ï¼‰åªè®©â€œä¸­æ–‡é¡µé¢è¯„è®ºåŒºâ€ç”¨ä½ çš„ä¸­æ–‡å­—ä½“ï¼šæŠŠ font-family æ¢æˆä½ è‡ªå·±çš„ */
html[lang^="zh"] #waline,
html[lang^="zh"] #waline *{
  /* font-family: 'KingHwa_OldSong', sans-serif !important; */
}

/* ===== FABï¼ˆæ¡Œé¢+æ‰‹æœºç»Ÿä¸€ï¼‰ ===== */
.kq-fab{
  position: fixed;
  right: 16px;
  bottom: 16px;
  display: none;              /* JS åˆ¤æ–­åå†æ˜¾ç¤º */
  flex-direction: column;     /* ç«–å‘ */
  gap: 12px;
  z-index: 9999;
}
.kq-fab.is-on{ display:flex; }

/* ç»Ÿä¸€å°ºå¯¸ï¼šbutton + a.top-linkï¼ˆä½ çš„ top.css ç»§ç»­æ§åˆ¶ top-link çš„èƒŒæ™¯/é˜´å½±ç­‰ï¼‰ */
.kq-fab :is(.kq-fab-btn, .top-link){
  width: 44px;
  height: 44px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* è‡ªå·±çš„ä¸¤ä¸ªæŒ‰é’® */
.kq-fab-btn{
  border: 1px solid var(--border, #ccc);
  background: var(--entry, #fff);
  color: var(--content, #222);
  transition: box-shadow .2s ease, transform .2s ease;
  box-shadow: 0px 2px 4px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
}
.kq-fab-btn:hover{
  box-shadow: 0px 4px 8px rgb(5 10 15 / 5%), 0px 7px 13px -3px rgb(5 10 15 / 30%);
}

/* top-link è¢«æ¬è¿› FAB åä¸è¦ fixedï¼›é¿å… top.css é‡Œ margin æ’‘å¤§ */
.kq-fab .top-link{
  position: static !important;
  padding: 0 !important;
  text-decoration: none;
}
.kq-fab .topInner{ margin: 0 !important; }

/* overlayï¼ˆé»˜è®¤ä¸æŒ¡ç‚¹å‡»ï¼‰ */
.kq-toc-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  opacity: 0; pointer-events: none;
  transition: opacity .18s ease;
  z-index: 9998;
}
html.kq-toc-open .kq-toc-overlay{
  opacity: 1; pointer-events: auto;
}

/* iPhone å®‰å…¨åŒº */
@media (max-width: 900px){
  .kq-fab{
    right: calc(16px + env(safe-area-inset-right));
    bottom: calc(16px + env(safe-area-inset-bottom));
  }

  /* æ‰‹æœºï¼šTOC æŠ½å±‰åŒ–ï¼ˆæ¡Œé¢ä¸æ”¹å¸ƒå±€ï¼‰ */
  #toc-container{
    position: fixed;
    top: 0; right: -86vw;
    width: 86vw; max-width: 340px;
    height: 100vh;
    background: var(--theme, #fff);
    border-left: 1px solid var(--border, #ccc);
    box-shadow: -10px 0 30px rgba(0,0,0,.12);
    transition: right .18s ease;
    z-index: 9999;
  }
  html.kq-toc-open #toc-container{ right: 0; }

  #toc-container .inner{
    max-height: calc(100vh - 56px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  #toc-container summary{ display:none; }
  #toc-container details{ height:100%; }
}
</style>

<div class="comment-toggle">
  {{- if $hasWaline -}}<button id="btn-waline" type="button">Waline ğŸ’¬</button>{{- end -}}
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

{{- if $hasWaline -}}
<div id="waline-container" class="comment-system">
  <div id="waline"></div>
  <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />

 <script>
  const btnWaline = document.getElementById('btn-waline');
  const btnGiscus = document.getElementById('btn-giscus');
  const walineContainer = document.getElementById('waline-container');
  const giscusContainer = document.getElementById('giscus-container');

  const GISCUS_TERM_RAW = {{ $commentPath | jsonify }};
  const GISCUS_REPO = "Liuqiran/liuqiran.github.io";
  const GISCUS_REPO_ID = "R_kgDONiVddQ";
  const GISCUS_CATEGORY = "General";
  const GISCUS_CATEGORY_ID = "DIC_kwDONiVddc4CljSp";

  function cleanString(x){
    return String(x ?? "").replace(/\\/g,"").replace(/["']/g,"").trim();
  }
  const GISCUS_TERM = cleanString(GISCUS_TERM_RAW);

  function normalizeGiscusLang(raw) {
    const l = String(raw || "").toLowerCase();
    if (l.startsWith("zh")) return "zh-CN";
    if (l.startsWith("ja") || l.startsWith("jp")) return "ja";
    return "en";
  }

  // ---- å…³é”®ï¼šWaline module æœªå°±ç»ªæ—¶çš„â€œå…œåº• stubâ€ ----
  window.__walineWanted = window.__walineWanted || false;
  if (typeof window.__ensureWaline !== 'function') {
    window.__ensureWaline = () => { window.__walineWanted = true; };
  }
  function triggerWalineInit() {
    window.__walineWanted = true;
    if (typeof window.__ensureWaline === 'function') window.__ensureWaline();
  }

  // ---- Giscus æ‡’åŠ è½½ ----
  let giscusLoaded = false;
  function ensureGiscus() {
    if (giscusLoaded) return;
    giscusLoaded = true;

    const lang = normalizeGiscusLang(document.documentElement.lang);
    const host = document.getElementById('giscus-comment');
    if (!host) return;

    host.innerHTML = "";

    const s = document.createElement('script');
    s.src = 'https://giscus.app/client.js';
    s.async = true;
    s.crossOrigin = 'anonymous';

    s.setAttribute('data-repo', GISCUS_REPO);
    s.setAttribute('data-repo-id', GISCUS_REPO_ID);
    s.setAttribute('data-category', GISCUS_CATEGORY);
    s.setAttribute('data-category-id', GISCUS_CATEGORY_ID);
    s.setAttribute('data-mapping', 'specific');
    s.setAttribute('data-term', GISCUS_TERM);
    s.setAttribute('data-strict', '0');
    s.setAttribute('data-reactions-enabled', '1');
    s.setAttribute('data-emit-metadata', '0');
    s.setAttribute('data-input-position', 'bottom');
    s.setAttribute('data-theme', 'preferred_color_scheme');
    s.setAttribute('data-lang', lang);

    host.appendChild(s);
  }

  function deferLoad(fn) {
    if ('requestIdleCallback' in window) {
      requestIdleCallback(fn, { timeout: 1200 });
    } else {
      setTimeout(fn, 250);
    }
  }

  // ---- UI åˆ‡æ¢ï¼ˆloadNow æ§åˆ¶æ˜¯å¦ç«‹åˆ»åŠ è½½ï¼‰----
  function showWaline(loadNow = true) {
    // Waline é…ç½®åå°±å›é€€åˆ° Giscus
    if (window.__walineBadConfig) return showGiscus(loadNow);

    if (!btnWaline || !walineContainer) return;
    btnWaline.classList.add('active');
    if (btnGiscus) btnGiscus.classList.remove('active');

    walineContainer.classList.add('active');
    if (giscusContainer) giscusContainer.classList.remove('active');

    localStorage.setItem('preferredComment', 'waline');

    if (loadNow) triggerWalineInit();
  }

  function showGiscus(loadNow = true) {
    if (!btnGiscus || !giscusContainer) return;
    btnGiscus.classList.add('active');
    if (btnWaline) btnWaline.classList.remove('active');

    giscusContainer.classList.add('active');
    if (walineContainer) walineContainer.classList.remove('active');

    localStorage.setItem('preferredComment', 'giscus');

    if (loadNow) ensureGiscus();
  }

  // ç»™ FAB ç”¨
  window.__kqShowWaline = () => showWaline(true);
  window.__kqShowGiscus = () => showGiscus(true);

  if (btnWaline) btnWaline.onclick = () => showWaline(true);
  if (btnGiscus) btnGiscus.onclick = () => showGiscus(true);

  // ---- é¦–å±ï¼šåªåˆ‡ UIï¼Œä¸ç«‹åˆ»åŠ è½½è¯„è®ºï¼›ç©ºé—²æ—¶å†åŠ è½½ä¸Šæ¬¡é€‰æ‹©çš„ç³»ç»Ÿ ----
  window.addEventListener('DOMContentLoaded', () => {
    const preferred = localStorage.getItem('preferredComment');

    const hasWaline = !!btnWaline && !!walineContainer && !window.__walineBadConfig;
    const hasGiscus = !!btnGiscus && !!giscusContainer;

    // å…ˆå†³å®šæ˜¾ç¤ºå“ªä¸ªï¼ˆä¸åŠ è½½ï¼‰
    if (!hasWaline && hasGiscus) {
      showGiscus(false);
      deferLoad(() => ensureGiscus());
      return;
    }

    if (preferred === 'giscus' && hasGiscus) {
      showGiscus(false);
      deferLoad(() => ensureGiscus());
      return;
    }

    // é»˜è®¤ Waline
    showWaline(false);
    deferLoad(() => triggerWalineInit());
  });
</script>

</div>
{{- end -}}

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

<div class="kq-toc-overlay" id="kq-toc-overlay" aria-hidden="true"></div>

<div class="kq-fab" id="kq-fab">
  <button class="kq-fab-btn" id="kq-fab-toc" type="button" aria-label="TOC">â˜°</button>
  <button class="kq-fab-btn" id="kq-fab-cmt" type="button" aria-label="Comments">ğŸ’¬</button>
</div>

<script>
/* ========= è¯„è®ºç³»ç»Ÿåˆ‡æ¢ï¼ˆWaline / Giscusï¼‰========= */

// stubï¼šå¦‚æœ module è¿˜æ²¡åŠ è½½ï¼Œå…ˆè®°ä¸ªâ€œæˆ‘æƒ³åˆå§‹åŒ– Walineâ€
window.__ensureWaline = window.__ensureWaline || function(){ window.__walineWanted = true; };

const btnWaline = document.getElementById('btn-waline');
const btnGiscus = document.getElementById('btn-giscus');
const walineContainer = document.getElementById('waline-container');
const giscusContainer = document.getElementById('giscus-container');

const GISCUS_TERM_RAW = {{ $commentPath | jsonify }};
const GISCUS_REPO = "Liuqiran/liuqiran.github.io";
const GISCUS_REPO_ID = "R_kgDONiVddQ";
const GISCUS_CATEGORY = "General";
const GISCUS_CATEGORY_ID = "DIC_kwDONiVddc4CljSp";

function cleanString(x){
  return String(x ?? "").replace(/\\/g,"").replace(/["']/g,"").trim();
}
const GISCUS_TERM = cleanString(GISCUS_TERM_RAW);

function normalizeGiscusLang(raw) {
  const l = String(raw || "").toLowerCase();
  if (l.startsWith("zh")) return "zh-CN";
  if (l.startsWith("ja") || l.startsWith("jp")) return "ja";
  return "en";
}

let giscusLoaded = false;
function ensureGiscus() {
  if (giscusLoaded) return;
  giscusLoaded = true;

  const lang = normalizeGiscusLang(document.documentElement.lang);
  const host = document.getElementById('giscus-comment');
  if (!host) return;

  host.innerHTML = "";

  const s = document.createElement('script');
  s.src = 'https://giscus.app/client.js';
  s.async = true;
  s.crossOrigin = 'anonymous';

  s.setAttribute('data-repo', GISCUS_REPO);
  s.setAttribute('data-repo-id', GISCUS_REPO_ID);
  s.setAttribute('data-category', GISCUS_CATEGORY);
  s.setAttribute('data-category-id', GISCUS_CATEGORY_ID);
  s.setAttribute('data-mapping', 'specific');
  s.setAttribute('data-term', GISCUS_TERM);
  s.setAttribute('data-strict', '0');
  s.setAttribute('data-reactions-enabled', '1');
  s.setAttribute('data-emit-metadata', '0');
  s.setAttribute('data-input-position', 'bottom');
  s.setAttribute('data-theme', 'preferred_color_scheme');
  s.setAttribute('data-lang', lang);

  host.appendChild(s);
}

function showGiscus() {
  if (!btnGiscus || !giscusContainer) return;
  btnGiscus.classList.add('active');
  if (btnWaline) btnWaline.classList.remove('active');
  giscusContainer.classList.add('active');
  if (walineContainer) walineContainer.classList.remove('active');
  localStorage.setItem('preferredComment', 'giscus');
  ensureGiscus();
}

function showWaline() {
  if (window.__walineBadConfig) return showGiscus();
  if (!btnWaline || !walineContainer) return;
  btnWaline.classList.add('active');
  if (btnGiscus) btnGiscus.classList.remove('active');
  walineContainer.classList.add('active');
  if (giscusContainer) giscusContainer.classList.remove('active');
  localStorage.setItem('preferredComment', 'waline');
  window.__ensureWaline();
}

window.__kqShowWaline = showWaline;
window.__kqShowGiscus = showGiscus;

if (btnWaline) btnWaline.onclick = showWaline;
if (btnGiscus) btnGiscus.onclick = showGiscus;

window.addEventListener('DOMContentLoaded', () => {
  const preferred = localStorage.getItem('preferredComment');

  // æ²¡ Waline / Waline é…ç½®å -> é»˜è®¤ Giscus
  if (!btnWaline || !walineContainer || window.__walineBadConfig) return showGiscus();

  if (preferred === 'giscus') return showGiscus();
  return showWaline();
});
</script>

<script>
/* ========= FABï¼šTop(æ¬è¿ä¸»é¢˜æŒ‰é’®) / TOC / Comments ========= */
(() => {
  const html = document.documentElement;
  const fab = document.getElementById('kq-fab');
  if (!fab) return;

  const btnTOC = document.getElementById('kq-fab-toc');
  const btnCmt = document.getElementById('kq-fab-cmt');
  const overlay = document.getElementById('kq-toc-overlay');
  const toc = document.getElementById('toc-container');
  const mqMobile = window.matchMedia('(max-width: 900px)');

  function closeTOC(){ html.classList.remove('kq-toc-open'); }

  function openTOC(){
    if (!toc) return;
    const d = toc.querySelector('details');
    if (d) d.open = true;

    if (mqMobile.matches) {
      html.classList.add('kq-toc-open'); // æ‰‹æœºæŠ½å±‰
    } else {
      toc.scrollIntoView({ behavior: 'smooth', block: 'start' }); // æ¡Œé¢æ»šåˆ°ç›®å½•
    }
  }

  btnTOC && btnTOC.addEventListener('click', openTOC);
  overlay && overlay.addEventListener('click', closeTOC);

  toc && toc.addEventListener('click', (e) => {
    const a = e.target.closest('a[href^="#"]');
    if (!a) return;
    if (mqMobile.matches) closeTOC();
  });

  btnCmt && btnCmt.addEventListener('click', () => {
    closeTOC();

    const preferred = localStorage.getItem('preferredComment');
    const hasWaline = !!document.getElementById('waline-container') && !window.__walineBadConfig;
    const hasGiscus = !!document.getElementById('giscus-container');

    if (preferred === 'giscus' && hasGiscus) window.__kqShowGiscus && window.__kqShowGiscus();
    else if (hasWaline) window.__kqShowWaline && window.__kqShowWaline();
    else if (hasGiscus) window.__kqShowGiscus && window.__kqShowGiscus();

    const active = document.querySelector('.comment-system.active');
    const target = (active && (active.querySelector('#waline') || active.querySelector('#giscus-comment')))
      || document.getElementById('waline')
      || document.getElementById('giscus-comment');

    if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // å°è¯• focus Waline
    let tries = 0;
    (function tryFocus(){
      tries++;
      const host = document.getElementById('waline');
      if (!host) return;
      const ta = host.querySelector('textarea');
      if (ta) { ta.focus({ preventScroll: true }); return; }
      const ed = host.querySelector('[contenteditable="true"]');
      if (ed) { ed.focus({ preventScroll: true }); return; }
      if (tries < 30) requestAnimationFrame(tryFocus);
    })();
  });

  // ===== åˆå§‹åŒ–ï¼šæ¬è¿ top-link + æŒ‰éœ€åˆ æŒ‰é’® + æ˜¾ç¤º FAB =====
  window.addEventListener('DOMContentLoaded', () => {
    // 1) æ¬è¿ä¸»é¢˜ top-linkï¼ˆä¿ç•™ä½  top.css çš„æ‰€æœ‰é€»è¾‘ï¼‰
    const topLink = document.querySelector('a.top-link');
    if (topLink && topLink.parentElement !== fab) {
      fab.prepend(topLink);
      topLink.setAttribute('aria-label', 'Top');
    }

    // 2) æ²¡ TOC åˆ  â˜°
    if (!toc && btnTOC) btnTOC.remove();

    // 3) æ²¡è¯„è®ºç³»ç»Ÿåˆ  ğŸ’¬
    const hasWaline = !!document.getElementById('waline-container') && !window.__walineBadConfig;
    const hasGiscus = !!document.getElementById('giscus-container');
    if (!hasWaline && !hasGiscus && btnCmt) btnCmt.remove();

    // 4) åªè¦ FAB é‡Œæœ€ç»ˆè¿˜æœ‰ä¸œè¥¿å°±æ˜¾ç¤º
     if (fab) fab.classList.add('is-on');
  });
})();
</script>
