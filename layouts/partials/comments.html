<style>
  .comment-toggle { margin-bottom: 1em; text-align: center; }
  .comment-toggle button{
    padding:.5em 1.2em; margin:0 .3em; cursor:pointer;
    border:1px solid #ccc; background:#f8f8f8; color:#555;
    font-weight:500; border-radius:4px; font-size:.9rem;
    transition:background .2s,color .2s,border-color .2s;
  }
  .comment-toggle button:hover{ background:#e2e2e2; border-color:#999; color:#333; }
  .comment-toggle button.active{
    background:#ccc; border-color:#999; color:#222;
    cursor:default; pointer-events:none;
  }
  .comment-system{ display:none; }
  .comment-system.active{ display:block; }
</style>

<div class="comment-toggle">
  <button id="btn-twikoo" type="button">Twikoo ğŸ’¬</button>
  <button id="btn-giscus" type="button">Giscus ğŸ’¬</button>
</div>

<!-- å…³é”®ï¼šTwikoo é»˜è®¤æ˜¾ç¤ºï¼Œé¿å…åœ¨ display:none ä¸‹åˆå§‹åŒ–å¤±è´¥ -->
<div id="twikoo-container" class="comment-system active">
  <div id="twikoo"></div>
</div>

<div id="giscus-container" class="comment-system">
  <div id="giscus-comment"></div>
</div>

{{- /* ========== ç»Ÿä¸€è¯„è®ºçº¿ç¨‹ï¼ˆA/Bï¼‰ï¼štranslationKey ä¼˜å…ˆï¼›å¦åˆ™å»è¯­è¨€å‰ç¼€å…œåº• ========== */ -}}
{{- $twPath := .RelPermalink -}}
{{- with .Params.translationKey -}}
  {{- $twPath = printf "/t/%s/" (. | urlize) -}}
{{- else -}}
  {{- $twPath = $twPath | replaceRE "^/(en|zh|ja)/" "/" -}}
{{- end -}}

{{- /* ========== envIdï¼šå»æ‰å¤´å°¾å¼•å· + å»æ‰æœ«å°¾ /ï¼ˆé˜²æ­¢ä½ ä¹‹å‰çš„ https://"https://... é—®é¢˜ï¼‰ ========== */ -}}
{{- $twEnv := .Site.Params.twikoo.id | default "" -}}
{{- $twEnv = $twEnv | strings.Trim " \"'" | strings.TrimSuffix "/" -}}
{{- $isURL := hasPrefix $twEnv "http" -}}

{{- /* ========== UI è¯­è¨€ ========== */ -}}
{{- $twLang := "en" -}}
{{- if hasPrefix (lower .Site.Language.Lang) "zh" -}}{{- $twLang = "zh-CN" -}}{{- end -}}

{{- $gLang := "en" -}}
{{- if hasPrefix (lower .Site.Language.Lang) "zh" -}}{{- $gLang = "zh-CN" -}}{{- end -}}

{{- /* ========== ç”¨ dict+jsonify ç”Ÿæˆ Twikoo é…ç½®ï¼Œé¿å…æ¨¡æ¿æŠŠ JS è¯­æ³•ææ–­ ========== */ -}}
{{- $twCfg := dict "envId" $twEnv "el" "#twikoo" "lang" $twLang "path" $twPath -}}
{{- if not $isURL -}}
  {{- $twCfg = merge $twCfg (dict "region" (.Site.Params.twikoo.region | default "ap-shanghai")) -}}
{{- end -}}

<script src="https://registry.npmmirror.com/twikoo/1.6.40/files/dist/twikoo.all.min.js"></script>

<script>
(function () {
  const btnTwikoo = document.getElementById('btn-twikoo');
  const btnGiscus = document.getElementById('btn-giscus');
  const twikooContainer = document.getElementById('twikoo-container');
  const giscusContainer = document.getElementById('giscus-container');

  let giscusLoaded = false;

  function setActive(which) {
    const isTw = which === 'twikoo';
    btnTwikoo.classList.toggle('active', isTw);
    btnGiscus.classList.toggle('active', !isTw);
    twikooContainer.classList.toggle('active', isTw);
    giscusContainer.classList.toggle('active', !isTw);
    localStorage.setItem('preferredComment', which);
  }

  // å…ˆ init Twikooï¼šè¯„è®º + é˜…è¯»é‡ twikoo_visitors éƒ½ä¾èµ–å®ƒ
  const twikooConfig = {{ $twCfg | jsonify }};
  if (window.twikoo) {
    window.twikoo.init(twikooConfig);
  } else {
    console.error("twikoo script not loaded");
  }

  function loadGiscusOnce() {
    if (giscusLoaded) return;
    const s = document.createElement('script');
    s.src = "https://giscus.app/client.js";
    s.setAttribute("data-repo", "Liuqiran/liuqiran.github.io");
    s.setAttribute("data-repo-id", "R_kgDONiVddQ");
    s.setAttribute("data-category", "General");
    s.setAttribute("data-category-id", "DIC_kwDONiVddc4CljSp");
    s.setAttribute("data-mapping", "title");
    s.setAttribute("data-strict", "0");
    s.setAttribute("data-reactions-enabled", "1");
    s.setAttribute("data-emit-metadata", "0");
    s.setAttribute("data-input-position", "bottom");
    s.setAttribute("data-theme", "preferred_color_scheme");
    s.setAttribute("data-lang", {{ $gLang | jsonify }}); // ä¸ä¼šå†å˜æˆ /"en"/
    s.crossOrigin = "anonymous";
    s.async = true;
    document.getElementById("giscus-comment").appendChild(s);
    giscusLoaded = true;
  }

  function showTwikoo() { setActive('twikoo'); }
  function showGiscus() { setActive('giscus'); loadGiscusOnce(); }

  btnTwikoo.addEventListener('click', showTwikoo);
  btnGiscus.addEventListener('click', showGiscus);

  // è®°ä½è®¿å®¢é€‰æ‹©
  const preferred = localStorage.getItem('preferredComment');
  if (preferred === 'giscus') showGiscus();
  else showTwikoo();
})();
</script>
